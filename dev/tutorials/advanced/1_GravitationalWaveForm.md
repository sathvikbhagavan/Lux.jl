


<a id='Training-a-Neural-ODE-to-Model-Gravitational-Waveforms'></a>

# Training a Neural ODE to Model Gravitational Waveforms


This code is adapted from [Astroinformatics/ScientificMachineLearning](https://github.com/Astroinformatics/ScientificMachineLearning/blob/c93aac3a460d70b4cce98836b677fd9b732e94b7/neuralode_gw.ipynb)


The code has been minimally adapted from [Keith et. al. 2021](https://arxiv.org/abs/2102.12695) which originally used Flux.jl


<a id='Package-Imports'></a>

## Package Imports


```julia
using Lux, ComponentArrays, LineSearches, LuxAMDGPU, LuxCUDA, OrdinaryDiffEq,
    Optimization, OptimizationOptimJL, Random, SciMLSensitivity
using CairoMakie, MakiePublication
CUDA.allowscalar(false)
```


<a id='Define-some-Utility-Functions'></a>

## Define some Utility Functions


::: tip


This section can be skipped. It defines functions to simulate the model, however, from a scientific machine learning perspective, isn't super relevant.


:::


We need a very crude 2-body path. Assume the 1-body motion is a newtonian 2-body position vector $r = r_1 - r_2$ and use Newtonian formulas to get $r_1$, $r_2$ (e.g. Theoretical Mechanics of Particles and Continua 4.3)


```julia
function one2two(path, m₁, m₂)
    M = m₁ + m₂
    r₁ = m₂ / M .* path
    r₂ = -m₁ / M .* path
    return r₁, r₂
end
```


```
one2two (generic function with 1 method)
```


Next we define a function to perform the change of variables: $(\chi(t),\phi(t)) \mapsto (x(t),y(t))$


```julia
@views function soln2orbit(soln, model_params=nothing)
    @assert size(soln, 1) ∈ [2, 4] "size(soln,1) must be either 2 or 4"

    if size(soln, 1) == 2
        χ = soln[1, :]
        ϕ = soln[2, :]

        @assert length(model_params)==3 "model_params must have length 3 when size(soln,2) = 2"
        p, M, e = model_params
    else
        χ = soln[1, :]
        ϕ = soln[2, :]
        p = soln[3, :]
        e = soln[4, :]
    end

    r = p ./ (1 .+ e .* cos.(χ))
    x = r .* cos.(ϕ)
    y = r .* sin.(ϕ)

    orbit = vcat(x', y')
    return orbit
end
```


```
soln2orbit (generic function with 2 methods)
```


This function uses second-order one-sided difference stencils at the endpoints; see https://doi.org/10.1090/S0025-5718-1988-0935077-0


```julia
function d_dt(v::AbstractVector, dt)
    a = -3 / 2 * v[1] + 2 * v[2] - 1 / 2 * v[3]
    b = (v[3:end] .- v[1:(end - 2)]) / 2
    c = 3 / 2 * v[end] - 2 * v[end - 1] + 1 / 2 * v[end - 2]
    return [a; b; c] / dt
end
```


```
d_dt (generic function with 1 method)
```


This function uses second-order one-sided difference stencils at the endpoints; see https://doi.org/10.1090/S0025-5718-1988-0935077-0


```julia
function d2_dt2(v::AbstractVector, dt)
    a = 2 * v[1] - 5 * v[2] + 4 * v[3] - v[4]
    b = v[1:(end - 2)] .- 2 * v[2:(end - 1)] .+ v[3:end]
    c = 2 * v[end] - 5 * v[end - 1] + 4 * v[end - 2] - v[end - 3]
    return [a; b; c] / (dt^2)
end
```


```
d2_dt2 (generic function with 1 method)
```


Now we define a function to compute the trace-free moment tensor from the orbit


```julia
function orbit2tensor(orbit, component, mass=1)
    x = orbit[1, :]
    y = orbit[2, :]

    Ixx = x .^ 2
    Iyy = y .^ 2
    Ixy = x .* y
    trace = Ixx .+ Iyy

    if component[1] == 1 && component[2] == 1
        tmp = Ixx .- trace ./ 3
    elseif component[1] == 2 && component[2] == 2
        tmp = Iyy .- trace ./ 3
    else
        tmp = Ixy
    end

    return mass .* tmp
end

function h_22_quadrupole_components(dt, orbit, component, mass=1)
    mtensor = orbit2tensor(orbit, component, mass)
    mtensor_ddot = d2_dt2(mtensor, dt)
    return 2 * mtensor_ddot
end

function h_22_quadrupole(dt, orbit, mass=1)
    h11 = h_22_quadrupole_components(dt, orbit, (1, 1), mass)
    h22 = h_22_quadrupole_components(dt, orbit, (2, 2), mass)
    h12 = h_22_quadrupole_components(dt, orbit, (1, 2), mass)
    return h11, h12, h22
end

function h_22_strain_one_body(dt::T, orbit) where {T}
    h11, h12, h22 = h_22_quadrupole(dt, orbit)

    h₊ = h11 - h22
    hₓ = T(2) * h12

    scaling_const = √(T(π) / 5)
    return scaling_const * h₊, -scaling_const * hₓ
end

function h_22_quadrupole_two_body(dt, orbit1, mass1, orbit2, mass2)
    h11_1, h12_1, h22_1 = h_22_quadrupole(dt, orbit1, mass1)
    h11_2, h12_2, h22_2 = h_22_quadrupole(dt, orbit2, mass2)
    h11 = h11_1 + h11_2
    h12 = h12_1 + h12_2
    h22 = h22_1 + h22_2
    return h11, h12, h22
end

function h_22_strain_two_body(dt::T, orbit1, mass1, orbit2, mass2) where {T}
    # compute (2,2) mode strain from orbits of BH 1 of mass1 and BH2 of mass 2

    @assert abs(mass1 + mass2 - 1.0)<1e-12 "Masses do not sum to unity"

    h11, h12, h22 = h_22_quadrupole_two_body(dt, orbit1, mass1, orbit2, mass2)

    h₊ = h11 - h22
    hₓ = T(2) * h12

    scaling_const = √(T(π) / 5)
    return scaling_const * h₊, -scaling_const * hₓ
end

function compute_waveform(dt::T, soln, mass_ratio, model_params=nothing) where {T}
    @assert mass_ratio≤1 "mass_ratio must be <= 1"
    @assert mass_ratio≥0 "mass_ratio must be non-negative"

    orbit = soln2orbit(soln, model_params)
    if mass_ratio > 0
        m₂ = inv(T(1) + mass_ratio)
        m₁ = mass_ratio * m₂

        orbit₁, orbit₂ = one2two(orbit, m₁, m₂)
        waveform = h_22_strain_two_body(dt, orbit1, mass1, orbit2, mass2)
    else
        waveform = h_22_strain_one_body(dt, orbit)
    end
    return waveform
end
```


```
compute_waveform (generic function with 2 methods)
```


<a id='Simulating-the-True-Model'></a>

## Simulating the True Model


`RelativisticOrbitModel` defines system of odes which describes motion of point like particle in schwarzschild background, uses


$$
u[1] = \chi
$$


$$
u[2] = \phi
$$


where, $p$, $M$, and $e$ are constants


```julia
function RelativisticOrbitModel(u, (p, M, e), t)
    χ, ϕ = u

    numer = (p - 2 - 2 * e * cos(χ)) * (1 + e * cos(χ))^2
    denom = sqrt((p - 2)^2 - 4 * e^2)

    χ̇ = numer * sqrt(p - 6 - 2 * e * cos(χ)) / (M * (p^2) * denom)
    ϕ̇ = numer / (M * (p^(3 / 2)) * denom)

    return [χ̇, ϕ̇]
end

mass_ratio = 0.0         # test particle
u0 = Float64[π, 0.0]     # initial conditions
datasize = 250
tspan = (0.0f0, 6.0f4)   # timespace for GW waveform
tsteps = range(tspan[1], tspan[2]; length=datasize)  # time at each timestep
dt_data = tsteps[2] - tsteps[1]
dt = 100.0
const ode_model_params = [100.0, 1.0, 0.5]; # p, M, e
```


Let's simulate the true model and plot the results using `OrdinaryDiffEq.jl`


```julia
prob = ODEProblem(RelativisticOrbitModel, u0, tspan, ode_model_params)
soln = Array(solve(prob, RK4(); saveat=tsteps, dt, adaptive=false))
waveform = first(compute_waveform(dt_data, soln, mass_ratio, ode_model_params))

fig = with_theme(theme_web()) do
    fig = Figure()
    ax = CairoMakie.Axis(fig[1, 1]; xlabel="Time", ylabel="Waveform")

    l = lines!(ax, tsteps, waveform; linewidth=2, alpha=0.75)
    s = scatter!(ax, tsteps, waveform; markershape=:circle, markeralpha=0.25, alpha=0.5)

    axislegend(ax, [[l, s]], ["Waveform Data"])

    return fig
end
```


![](1_GravitationalWaveForm-24.png)


<a id='Defiing-a-Neural-Network-Model'></a>

## Defiing a Neural Network Model


Next, we define the neural network model that takes 1 input (time) and has two outputs. We'll make a function `ODE_model` that takes the initial conditions, neural network parameters and a time as inputs and returns the derivatives.


It is typically never recommended to use globals but incase you do use them, make sure to mark them as `const`.


We will deviate from the standard Neural Network initialization and use `WeightInitializers.jl`,


```julia
const nn = Chain(Base.Fix1(broadcast, cos),
    Dense(1 => 32, cos; init_weight=truncated_normal(; std=1e-4)),
    Dense(32 => 32, cos; init_weight=truncated_normal(; std=1e-4)),
    Dense(32 => 2; init_weight=truncated_normal(; std=1e-4)))
ps, st = Lux.setup(MersenneTwister(), nn)
```


```
((layer_1 = NamedTuple(), layer_2 = (weight = Float32[-7.39481f-5; 2.141996f-5; 0.00017322219; 8.316032f-5; 0.00015331723; 5.5071534f-5; -5.6964822f-5; 8.254935f-5; -0.000119726916; -1.967344f-5; 0.00014250736; 9.3949166f-5; -5.6542955f-5; 5.3265747f-5; -6.5186855f-6; 1.2503275f-6; -9.356874f-5; 2.3220495f-5; -0.00014736339; -8.056438f-6; 2.6172209f-5; -4.8370115f-5; -2.1449985f-5; 8.767791f-5; 0.00018672222; 0.00016392075; -8.057516f-5; 2.6177899f-5; 4.0547653f-5; 4.8570287f-6; 0.00015359065; 6.8106465f-6;;], bias = Float32[0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0;;]), layer_3 = (weight = Float32[7.315833f-5 -6.577648f-6 0.00014773417 -0.00028871367 -1.0107304f-5 -0.0002372628 -2.6863741f-5 -0.00028957322 -0.000118773605 4.7203626f-5 -0.00012646781 -0.00013914486 -0.00010128422 0.00011752651 6.915091f-5 0.00012401683 -0.00010260895 -0.00015848543 -6.864857f-5 -1.8391675f-5 0.000110433946 5.8741814f-5 -2.3996718f-6 2.3257242f-5 -4.2883457f-5 1.720969f-5 -3.0960175f-5 7.8089535f-5 8.19185f-5 0.000105607 -0.00013176905 6.0974562f-5; -5.4822893f-5 0.00010185913 -3.3237528f-5 2.6211235f-5 0.000106079606 -0.0001168459 -6.7580746f-5 -0.00010291446 0.0002639166 -0.00018839042 7.2860355f-5 -9.048838f-6 -0.00019030043 -9.3093666f-7 -3.0756255f-5 9.301057f-5 2.6240152f-5 -0.00013713697 -1.0327174f-6 -0.00021829482 7.9169535f-5 -8.0147234f-5 -0.00011141392 0.00012581868 5.3811007f-5 4.4055534f-5 0.00010485668 9.078569f-5 -1.02483245f-5 -7.025545f-5 4.9616443f-5 0.00012660689; -6.4478605f-5 0.00021273358 -0.000113616785 -6.8478024f-5 0.00017706415 2.0358919f-5 -7.4193136f-5 -0.00017830361 0.00013677342 1.587727f-5 7.552424f-5 -4.89453f-5 -3.5446043f-5 -7.3848096f-5 -1.35907885f-5 8.303793f-5 -3.6603302f-5 -0.00012410322 -2.827972f-5 9.593834f-5 3.3839322f-5 1.5283173f-5 1.6928412f-5 6.1843195f-5 -0.00011489208 -7.520335f-5 4.497603f-5 -0.00016260476 -3.9486746f-5 0.000102420505 -0.00013108534 0.00013131852; 1.9965686f-5 -3.2002354f-5 5.6430663f-6 -2.6573423f-5 0.00015093172 0.00013235939 -0.00012138803 -3.887116f-5 0.00017294395 0.000121024765 -6.167747f-5 0.00011137214 9.636892f-5 7.275624f-5 5.6055956f-6 -1.9764844f-5 -1.9130594f-5 -9.9175224f-5 -6.462302f-5 0.00010559333 -4.683618f-7 -0.00029858275 9.067173f-5 0.00012369518 -1.4455049f-5 -6.8512004f-6 -2.634919f-5 -1.7470835f-5 -1.0913673f-5 -0.0001612161 -9.4748875f-6 -0.00016622544; 2.6216183f-5 0.00014756549 -0.00010577253 0.00011427771 5.125899f-5 0.00011976982 6.4143074f-5 0.00022525739 -6.0162314f-5 -7.18073f-5 -9.5628035f-5 -4.861059f-5 -5.8494254f-5 7.138933f-5 -2.3469956f-5 -6.5307104f-5 3.0883726f-5 -3.316276f-5 0.00015883322 -1.87838f-5 -1.9861049f-5 -0.0001485802 7.5236385f-5 3.0595173f-5 -0.00012988658 -3.0941148f-5 -2.5382824f-5 9.312594f-5 -5.9406728f-5 -3.5078396f-5 2.5857826f-5 -3.3461565f-5; -3.9241877f-6 2.1049356f-5 7.8071134f-5 4.47539f-5 7.992985f-5 -0.00011510741 7.5342745f-5 5.3369222f-5 -3.1512503f-5 -8.596064f-5 -7.696821f-5 3.9858838f-5 2.5694503f-6 -2.0321884f-5 -4.0384104f-5 -6.954437f-5 0.0002198221 -2.9361667f-5 -6.973195f-5 1.5225008f-5 -9.423005f-5 -5.4015505f-5 -4.9072227f-5 -1.2103128f-5 0.00011316769 8.569033f-5 -5.95831f-5 -0.00016293753 -0.0001254703 -8.098582f-5 -5.5708744f-5 -0.00016338828; 3.6073445f-5 6.371105f-5 -1.5518724f-5 8.410387f-5 -3.4084554f-5 7.846937f-5 -5.0379126f-6 0.0001269731 6.593505f-5 -0.00013574943 -2.5250272f-5 -7.508296f-5 1.7963723f-5 3.6986126f-5 0.00012181469 -0.00015241664 -0.00019308693 -5.922157f-5 0.000110498026 1.7570226f-8 -8.605825f-9 -2.2241225f-5 -4.934626f-5 1.3890294f-5 8.351282f-6 -7.481593f-5 -0.00010948144 -0.00011554739 7.136597f-5 8.1968414f-5 3.4320834f-5 -0.00015645318; -0.00015605633 -4.8536887f-5 -6.917737f-5 -1.9681787f-5 -5.7406694f-5 0.00019544887 -1.9588571f-5 3.2357704f-5 3.704494f-5 0.00016359854 -0.000100798876 9.5063304f-5 -5.4897955f-5 6.514952f-5 -1.0601013f-5 -7.0022f-5 -7.572956f-5 0.00020171606 -0.000104383245 9.664454f-6 -2.2269744f-5 4.5300138f-5 -0.00013259237 3.9666f-5 8.614644f-5 -0.00017440313 2.34718f-5 1.91835f-6 5.737555f-5 -6.157703f-5 -1.8908543f-6 1.8752475f-5; 3.6911937f-5 -2.0249745f-5 4.8937924f-5 1.8896919f-5 -2.3595849f-5 1.6407657f-5 -7.0648307f-6 0.00012878697 4.5447927f-5 -4.1431496f-5 -5.5746088f-5 -0.00013925415 -0.00012232891 -6.93247f-9 0.00015672465 3.882028f-5 -3.709817f-5 -0.00021258736 -0.00012653173 7.175588f-5 -0.0001602537 2.5429115f-5 -9.170661f-5 0.00014078044 7.244382f-5 5.668566f-6 2.8658695f-5 6.8228965f-6 2.4514547f-5 -0.00014489194 -0.00017932784 -5.8901427f-5; -4.6386223f-5 -6.0860704f-5 8.048284f-5 2.1832933f-5 4.744353f-5 -0.000112138434 -1.8621784f-5 0.00010329778 9.984531f-6 -5.199172f-5 4.2696705f-5 -5.2611744f-5 -4.1505384f-5 -3.5900335f-5 -0.00014444269 -8.856961f-5 -1.0534245f-5 3.7847483f-5 -3.2229706f-5 3.0168338f-5 -0.0001345326 -6.407658f-5 3.6251909f-6 6.703761f-5 -6.162551f-5 9.7769946f-5 2.4162398f-5 -8.516099f-5 -5.6009532f-5 -6.8748323f-6 -8.843717f-5 -2.6142865f-5; 0.0001049423 -1.9320836f-5 0.0001911875 9.1797796f-5 2.0093517f-5 0.00016448795 -1.1491818f-5 -0.00011025214 -0.00017396275 -9.054168f-5 3.5456193f-5 0.00010305416 0.00014435522 3.8640588f-5 8.9423615f-5 -1.3159736f-5 -0.00020133064 3.0125779f-5 -0.00013113474 -6.082384f-7 -0.00012468951 0.00023534476 3.7558355f-5 -0.0002164313 2.0939387f-5 5.514548f-5 5.7855592f-5 -5.5885066f-6 -0.0002601221 3.60128f-5 -5.309633f-5 -0.00015933557; -4.7182584f-5 4.125779f-5 -6.721552f-5 -0.00011061541 -5.613129f-5 -4.80848f-5 -0.00013520803 -9.575956f-6 1.7332588f-5 5.115375f-6 8.210032f-5 7.667029f-7 -0.000109123255 -1.5819203f-5 -3.3670676f-6 -1.984194f-5 4.2901247f-5 9.4558585f-5 -2.6468439f-5 0.0001682183 0.00019511058 6.531169f-5 -2.6295606f-7 0.00018433605 7.468428f-5 -3.3649623f-5 -0.00015023572 -4.2637992f-5 5.296619f-5 0.0001105458 -7.6660086f-5 -0.00013314729; 0.0002042801 0.00015432885 6.141418f-5 -1.3649479f-5 0.00010098001 7.55229f-5 5.30145f-5 3.0376648f-5 4.9569848f-5 -0.00016238212 0.00016818535 -7.559409f-5 6.793704f-5 7.4517724f-5 -0.00012030791 7.752267f-5 -6.229987f-5 1.826505f-5 0.00015292881 3.2460716f-6 8.294339f-5 -0.00015690082 -9.2388305f-5 -0.00010832231 -4.5995326f-5 -1.5530097f-5 -7.611691f-5 -3.767603f-5 -0.00028837955 4.552401f-5 1.1340382f-5 2.753769f-5; -5.180163f-5 -7.965965f-5 -6.36289f-5 0.00011203119 0.00014725886 9.079296f-5 -1.643655f-5 -7.9029436f-5 -8.417786f-5 -2.007062f-5 2.393335f-6 -0.00010855971 0.00012287938 -0.00010461399 2.118276f-5 -8.919004f-5 -4.412245f-5 0.00018989273 -4.1418112f-5 8.24141f-5 -6.2469866f-5 -1.1070268f-5 -4.9726208f-5 -0.0002964938 0.00015145275 -3.105693f-5 -6.039319f-5 -0.00012014312 -0.00014765741 6.702149f-5 -0.00015618875 -4.726179f-5; 0.00014614055 9.023365f-6 0.00013161635 6.299369f-5 -0.00014668865 -6.309528f-5 0.000104976825 1.0174913f-5 2.0313466f-5 -0.000120381505 0.000199279 -0.00010012545 6.417176f-6 0.0002926999 3.283246f-5 -4.91064f-6 -0.00015280096 0.00010719692 -5.7946894f-5 0.000104416744 0.00013830514 0.00022305807 -8.975477f-5 8.108192f-5 7.126725f-5 -1.1322041f-7 1.7537557f-5 2.6504524f-5 6.730855f-5 -7.6079865f-5 -0.00017479224 6.218693f-5; -5.335289f-5 5.1456187f-5 0.00015944509 -1.4313991f-5 0.00021809875 -8.476368f-5 2.793837f-5 -8.8260276f-5 -3.160374f-5 -0.00018150378 -7.2487186f-5 6.5285654f-5 -2.7563605f-5 -7.2057795f-5 0.00013625015 -4.569782f-5 2.0291807f-5 0.0001398214 5.004258f-5 -0.00013524113 -4.6846082f-5 0.00017274392 -7.7404846f-5 -6.20406f-5 -3.858151f-5 -0.0001483952 9.779077f-5 -0.00013181932 4.994043f-5 0.00013576633 -2.6416545f-5 9.569433f-5; -9.929692f-5 5.8848942f-5 -0.00010578367 8.185278f-5 -0.00014698406 -2.486996f-5 8.536226f-5 -3.668971f-5 4.9241058f-5 4.8115628f-5 0.00010880324 3.8768572f-5 -0.00015557575 1.9038906f-5 -7.102516f-5 -0.00012723004 -0.00016698358 3.6911233f-6 -9.361283f-5 8.1873746f-5 -2.083613f-5 -5.34732f-5 -4.6334884f-5 1.8068471f-5 8.6033426f-5 4.4285312f-5 3.5175966f-5 -9.350178f-5 2.5058222f-5 0.00012974904 -0.00019606175 0.000104756844; -5.2155192f-5 1.7439008f-5 -9.624554f-5 -3.293945f-5 -3.919837f-5 -6.3154395f-5 -7.625151f-5 -3.863885f-5 -3.007322f-5 9.9011915f-5 4.715857f-5 -5.0793682f-5 2.6940825f-5 -2.9101422f-5 2.5759153f-5 -0.00014217464 -0.000121840305 -2.738859f-5 6.387583f-5 9.754384f-5 -5.2122155f-5 0.00015790002 0.00022369146 -3.1224795f-6 0.00016382257 -2.5219764f-5 0.00014337203 6.208757f-6 -0.00013456304 -5.805791f-5 -0.00016737869 -0.00011958973; 0.00011991204 -4.7601596f-5 -4.0916173f-5 -7.5342825f-5 -0.00021166918 0.00014308217 9.90673f-5 9.967541f-5 0.00023327833 0.00011185998 7.658198f-5 7.365517f-7 0.0002539969 8.758403f-5 -5.6988547f-6 0.00012242224 -0.0001369576 3.967699f-6 0.00015181661 4.7648962f-7 -8.375726f-5 -0.00014174634 -4.5706776f-5 0.00012564985 3.268645f-5 -7.589489f-5 -0.00016357291 -1.8859529f-6 -4.7080506f-5 -7.948261f-5 0.00010416576 7.4491874f-7; 1.010424f-5 5.016915f-5 0.00013413254 -0.00014330968 -0.00018590639 -0.00013254589 -1.7167748f-5 -0.00012677323 -4.2868618f-5 -5.512332f-5 -2.4473964f-5 -5.6196575f-5 8.792068f-5 0.00011685045 3.8914895f-5 7.726856f-5 -9.482385f-5 0.00013524292 1.3161544f-5 -3.4151413f-5 0.0001346619 3.926879f-6 -1.1609076f-5 -9.8471224f-5 -3.2081844f-5 2.8867074f-5 -3.425726f-5 -1.79701f-5 4.6322642f-5 -6.606267f-5 -4.728471f-5 -7.997831f-5; -4.4548586f-5 2.3000694f-5 -8.395169f-5 -1.6829067f-6 -9.764193f-5 8.721619f-5 6.5501314f-5 -7.342546f-5 8.855276f-5 0.00025183742 8.307114f-6 0.00016308365 0.00020704351 8.797008f-5 -8.959967f-5 -0.00015837997 -9.353389f-5 -8.381087f-5 -1.6316593f-5 -6.225003f-5 -2.2633549f-5 3.303827f-5 -6.592543f-5 0.00013214567 -0.00022957675 -4.9836573f-5 0.00013176008 0.00018609631 8.633199f-5 5.229944f-5 -2.7468392f-5 1.9956633f-5; -3.635435f-5 7.505757f-5 -3.3803757f-5 -0.00010047357 6.012078f-5 0.00011809916 5.6741126f-5 -5.96838f-5 5.2049265f-5 -9.1466f-5 -0.000117074895 -0.00013213058 4.5186436f-5 7.820413f-5 -2.6664411f-5 1.1667349f-5 -3.7675003f-5 4.3827105f-5 -3.0837815f-5 7.352175f-5 -3.6038527f-5 -4.7989915f-6 -0.00011211182 0.00011256983 0.00016209665 -0.00010359336 -9.102967f-6 6.90759f-5 0.000116233525 -0.000113608694 -0.00015249697 -9.311082f-5; 0.00013778717 0.00010485652 -0.00016639318 -8.1649974f-5 2.310561f-5 -0.00014349323 -0.00015649394 1.848236f-6 6.167054f-5 8.857404f-5 1.4712752f-5 -1.6219457f-5 -6.0288698f-5 -6.976389f-5 5.209178f-6 -5.115375f-6 -6.154395f-5 -0.00017108847 0.00017083026 4.110027f-5 1.3363458f-5 -0.00016956296 -3.3078068f-5 -7.310629f-5 -5.5607885f-5 -0.000103501676 -4.2974283f-5 6.786615f-5 7.276792f-5 5.105202f-6 -2.9950503f-5 -9.856866f-5; 0.00016003728 8.2386745f-5 0.00010805176 -0.00012011041 -6.3445266f-5 -4.606406f-5 5.982254f-5 -0.0002275881 -0.00015365999 -2.5799527f-5 0.00013164086 3.9910316f-5 -0.00010848831 0.00015392773 2.225988f-5 3.600151f-5 0.000111798945 8.6995584f-5 0.00015699993 0.00016312941 -1.0677162f-5 -0.00016384406 0.00016069456 -1.336584f-5 -7.032615f-5 7.63765f-5 -0.00010976912 -0.00018681966 4.9580558f-5 1.0882622f-5 2.6549775f-5 0.00029736006; 2.9267183f-5 3.9919378f-5 -0.00015442714 0.00019673917 -5.9157697f-5 5.1471776f-5 -6.458307f-5 4.877779f-5 9.711979f-6 -3.7935868f-5 -7.135926f-5 0.00014953282 2.0420393f-5 -7.299239f-5 -9.592769f-5 -7.388566f-5 2.1973083f-5 -8.6073494f-5 -2.5847969f-5 1.588886f-5 0.00016506249 4.396086f-5 -9.424538f-5 4.1806576f-5 5.4824526f-5 4.313912f-5 -3.554018f-5 0.0001844152 -3.8177004f-6 -0.000117232004 1.3289445f-5 0.00014734268; 9.6815485f-5 0.0001135662 -0.00028598536 -0.0002573217 0.00020086074 5.8273607f-5 4.412769f-5 2.5552805f-5 -0.00011420615 -0.00013350391 -0.00015076318 9.238936f-5 -2.2205146f-5 2.7342245f-5 3.086793f-5 5.3787247f-5 -0.00020701549 -4.943555f-5 4.2676544f-5 0.00021766596 0.00019717003 -0.0001182521 7.555803f-5 -0.00016949192 -5.9303668f-5 2.1757536f-5 0.00016667908 -0.00015296653 -8.192335f-5 -4.3355867f-5 6.1032904f-5 0.00014051034; 0.00012714464 2.0806907f-5 -4.359618f-5 -0.00011601514 1.0281453f-6 -6.98515f-6 9.84557f-5 7.427048f-5 -8.2126775f-5 -0.0002080649 -6.309684f-5 -9.690858f-5 6.6594286f-5 -9.13971f-5 -6.90037f-5 -0.00012150148 -2.8142282f-5 1.043335f-5 4.215661f-5 -2.0191006f-5 8.421807f-5 -0.00014103275 -7.979121f-5 0.00023446094 -1.76876f-5 -4.365274f-5 2.870269f-5 -4.4390446f-5 -0.00015271622 -0.00011724573 -0.00013970467 -8.060815f-6; 2.3627681f-5 9.801225f-5 -9.956287f-5 -0.00011898816 5.0861756f-5 -5.3344553f-5 -4.5930698f-5 -8.1877384f-5 -0.00010577635 -1.3679521f-5 9.239472f-5 4.8786846f-5 -7.5218064f-5 -2.3722116f-5 1.27543235f-5 -0.000101298196 -0.00012213453 5.3613632f-5 -7.0475716f-7 5.0525334f-5 -9.047538f-5 -3.6579146f-5 0.00019653098 -4.648969f-6 7.898265f-5 5.483286f-5 9.152331f-5 0.0002628503 6.5423123f-6 -7.9377617f-7 -0.00029591253 -2.04295f-6; -0.00010841305 -3.970344f-5 -0.00019324812 0.00012656653 4.5519537f-5 -6.663122f-5 8.80298f-5 2.9608624f-5 5.8879927f-5 -2.7736593f-5 3.5723265f-6 -2.5985344f-6 0.00022417256 -0.000113349735 0.00012366308 -0.000121765326 0.00016032852 0.00010239607 -0.000106786305 -0.00021904681 0.00010404888 1.5584628f-5 3.2846023f-5 -7.331685f-5 9.639747f-6 -8.244021f-5 4.5807476f-5 -4.7563313f-5 0.0001088088 -0.0002107638 2.6053021f-5 4.185468f-5; -1.4025503f-5 1.5177972f-5 0.00014560878 1.23789f-5 4.1024425f-5 -2.7776156f-5 -7.2923256f-5 5.1494055f-5 6.9330425f-5 2.0214009f-6 6.842927f-5 4.0782612f-5 -2.642804f-6 -2.695449f-5 3.169683f-5 -3.699803f-5 -1.532674f-5 -0.00021201574 5.2324933f-5 0.00010518614 2.791721f-5 0.000187415 -9.375732f-5 -1.3830891f-5 -0.00017523878 0.00014372778 -7.1490955f-5 -4.0803166f-5 -0.00017614814 -0.0001342897 5.6720277f-5 0.0001579516; 5.634427f-5 3.817125f-5 3.0399679f-6 -5.133636f-5 0.0001614778 9.4206436f-5 -0.00013991613 3.6863894f-5 9.942038f-5 -6.0763927f-5 8.937852f-5 0.00017542389 0.00017170585 0.000109887915 -7.2840057f-6 4.502827f-5 -8.595951f-5 -1.6330885f-5 -2.593423f-6 1.3051024f-5 -0.00015113871 2.313234f-5 5.640592f-5 0.00018645829 -2.0957224f-5 -0.00011576617 -3.6664365f-5 7.077708f-5 0.00035076746 4.495087f-5 5.8141646f-5 0.00014548986; 1.3648062f-5 -2.8239043f-5 8.479569f-5 -0.00018651118 7.556228f-5 -7.059023f-5 -0.00014035165 -1.4365737f-5 -5.819664f-5 0.000101309575 -3.4080596f-5 -0.000107649306 1.757646f-5 0.00015525233 -0.00014815577 -5.6585206f-5 6.5987384f-5 0.00011116287 3.626463f-5 0.00012833216 -0.00017676577 -0.00013504675 1.6751595f-5 -6.746593f-5 -0.00028832036 -1.2429367f-5 9.0039845f-5 0.000102602324 -0.00013190437 -2.0614727f-5 -2.8493443f-5 -0.00017396262], bias = Float32[0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0;;]), layer_4 = (weight = Float32[2.9433117f-8 -1.8128612f-5 -0.00013661552 -9.171198f-5 -1.1328563f-5 -1.3714419f-5 2.1986214f-5 0.00013867437 -0.00016722875 5.9362425f-5 3.1336906f-6 3.606984f-7 -6.0280418f-5 0.00014415687 5.981586f-5 0.00014105724 -0.00017218413 6.776608f-5 5.1053208f-5 -0.00018283962 8.707754f-5 7.543271f-5 -9.03697f-5 -0.00012496408 -5.9459497f-5 -2.3181174f-5 0.00013706661 -1.1429376f-5 8.3941784f-5 0.00016173211 0.000121835656 -7.03682f-5; 0.000106342806 -0.00014447645 -5.014387f-5 6.0109f-5 4.6539513f-5 0.00010324644 0.00014337304 2.0592872f-5 -0.00012821582 6.5006534f-5 -2.0928326f-6 1.3184965f-5 -3.365209f-5 -5.2875f-5 -0.00013178699 0.00016710175 -3.6427366f-5 -2.2760241f-5 9.331522f-5 -2.8405015f-5 -4.5489578f-5 7.34086f-5 -9.36623f-5 4.1557403f-5 -0.00011416841 -9.9222394f-5 -7.363718f-5 5.5289525f-5 -0.00010958657 -7.6768854f-5 2.3300501f-5 -0.00016017594], bias = Float32[0.0; 0.0;;])), (layer_1 = NamedTuple(), layer_2 = NamedTuple(), layer_3 = NamedTuple(), layer_4 = NamedTuple()))
```


Similar to most DL frameworks, Lux defaults to using `Float32`, however, in this case we need Float64


```julia
const params = ComponentArray{Float64}(ps)
```


```
ComponentVector{Float64}(layer_1 = Float64[], layer_2 = (weight = [-7.394809654215351e-5; 2.1419960830826312e-5; 0.00017322218627668917; 8.31603174447082e-5; 0.00015331723261624575; 5.507153400685638e-5; -5.696482185157947e-5; 8.25493480078876e-5; -0.00011972691572736949; -1.9673439965117723e-5; 0.00014250735694076866; 9.39491656026803e-5; -5.65429545531515e-5; 5.326574682840146e-5; -6.5186854953935836e-6; 1.25032750020182e-6; -9.356874215882272e-5; 2.3220494767883793e-5; -0.0001473633892601356; -8.056437764025759e-6; 2.6172208890784532e-5; -4.8370115109719336e-5; -2.144998506992124e-5; 8.767790859565139e-5; 0.00018672221631277353; 0.00016392074758186936; -8.057516242843121e-5; 2.6177898689638823e-5; 4.054765304317698e-5; 4.857028670812724e-6; 0.00015359064855147153; 6.810646482335869e-6;;], bias = [0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0;;]), layer_3 = (weight = [7.315832772292197e-5 -6.5776480369095225e-6 0.00014773417206015438 -0.0002887136652134359 -1.0107303751283325e-5 -0.00023726279323454946 -2.6863741368288174e-5 -0.00028957321774214506 -0.00011877360520884395 4.7203626309055835e-5 -0.0001264678139705211 -0.00013914486044086516 -0.00010128421854460612 0.00011752651334973052 6.915091216797009e-5 0.00012401683488860726 -0.0001026089521474205 -0.0001584854326210916 -6.864857277832925e-5 -1.8391674529993907e-5 0.00011043394624721259 5.874181442777626e-5 -2.3996717573027126e-6 2.3257241991814226e-5 -4.288345735403709e-5 1.72096897586016e-5 -3.096017462667078e-5 7.808953523635864e-5 8.191850065486506e-5 0.00010560700320638716 -0.00013176904758438468 6.097456207498908e-5; -5.482289270730689e-5 0.00010185912833549082 -3.323752753203735e-5 2.6211235308437608e-5 0.00010607960575725883 -0.00011684589844662696 -6.758074596291408e-5 -0.00010291446233168244 0.0002639165904838592 -0.00018839041877072304 7.286035543074831e-5 -9.0488383648335e-6 -0.00019030043040402234 -9.309366646448325e-7 -3.0756255000596866e-5 9.301056707045063e-5 2.6240151782985777e-5 -0.00013713697262573987 -1.032717364068958e-6 -0.00021829482284374535 7.916953472886235e-5 -8.014723425731063e-5 -0.00011141392315039411 0.0001258186821360141 5.381100709200837e-5 4.4055534090148285e-5 0.00010485667735338211 9.078568837139755e-5 -1.0248324542772025e-5 -7.025545346550643e-5 4.961644299328327e-5 0.0001266068866243586; -6.44786050543189e-5 0.0002127335756085813 -0.00011361678480170667 -6.84780243318528e-5 0.00017706415383145213 2.0358918845886365e-5 -7.419313624268398e-5 -0.00017830361321102828 0.00013677342212758958 1.5877269106567837e-5 7.552424358436838e-5 -4.894530138699338e-5 -3.544604260241613e-5 -7.384809578070417e-5 -1.3590788512374274e-5 8.303792856168002e-5 -3.660330185084604e-5 -0.00012410321505740285 -2.8279719117563218e-5 9.59383396548219e-5 3.383932198630646e-5 1.5283172615454532e-5 1.692841215117369e-5 6.184319499880075e-5 -0.00011489207827253267 -7.520335202571005e-5 4.497603003983386e-5 -0.00016260475968010724 -3.9486745663452893e-5 0.00010242050484521315 -0.0001310853403992951 0.00013131852028891444; 1.9965686078649014e-5 -3.2002353691495955e-5 5.643066288030241e-6 -2.657342338352464e-5 0.00015093172260094434 0.00013235938968136907 -0.00012138803140260279 -3.88711596315261e-5 0.0001729439536575228 0.00012102476466679946 -6.16774705122225e-5 0.00011137213732581586 9.636892355047166e-5 7.275623647728935e-5 5.605595561064547e-6 -1.9764844182645902e-5 -1.9130593500449322e-5 -9.917522402247414e-5 -6.462301826104522e-5 0.00010559333168203011 -4.683618044509785e-7 -0.00029858274501748383 9.067173232324421e-5 0.00012369517935439944 -1.4455048585659824e-5 -6.851200396340573e-6 -2.634918928379193e-5 -1.7470834791311063e-5 -1.0913672667811625e-5 -0.00016121609951369464 -9.474887519900221e-6 -0.00016622543625999242; 2.6216182959615253e-5 0.00014756548625882715 -0.00010577253124210984 0.00011427771096350625 5.125899042468518e-5 0.00011976982204942033 6.414307426894084e-5 0.00022525739041157067 -6.016231418470852e-5 -7.180729880928993e-5 -9.562803461449221e-5 -4.8610589146846905e-5 -5.849425360793248e-5 7.138933142414317e-5 -2.3469956431654282e-5 -6.530710379593074e-5 3.088372614001855e-5 -3.3162759791594e-5 0.00015883322339504957 -1.8783799532684498e-5 -1.986104871321004e-5 -0.0001485802058596164 7.523638487327844e-5 3.059517257497646e-5 -0.0001298865827266127 -3.094114799750969e-5 -2.538282387831714e-5 9.312594193033874e-5 -5.9406727814348415e-5 -3.5078395740129054e-5 2.5857825676212087e-5 -3.3461565180914477e-5; -3.924187694792636e-6 2.1049356291769072e-5 7.807113433955237e-5 4.4753898691851646e-5 7.992985047167167e-5 -0.00011510741023812443 7.534274482168257e-5 5.336922185961157e-5 -3.151250348309986e-5 -8.596063707955182e-5 -7.696820830460638e-5 3.9858838135842234e-5 2.5694503165141214e-6 -2.032188422163017e-5 -4.0384104067925364e-5 -6.954436685191467e-5 0.00021982210455462337 -2.9361666747718118e-5 -6.973194831516594e-5 1.5225007700792048e-5 -9.423004667041823e-5 -5.4015505156712607e-5 -4.9072226829594e-5 -1.2103128028684296e-5 0.00011316769086988643 8.569032797822729e-5 -5.958310066489503e-5 -0.00016293753287754953 -0.00012547029473353177 -8.098581747617573e-5 -5.570874418481253e-5 -0.0001633882784517482; 3.607344478950836e-5 6.371104973368347e-5 -1.5518724467256106e-5 8.410387090407312e-5 -3.4084554499713704e-5 7.846936932764947e-5 -5.037912615080131e-6 0.00012697310012299567 6.593504804186523e-5 -0.00013574943295679986 -2.525027230149135e-5 -7.508295675506815e-5 1.7963722712011077e-5 3.69861263607163e-5 0.00012181469355709851 -0.00015241664368659258 -0.00019308693299535662 -5.9221569244982675e-5 0.0001104980256059207 1.7570226162888503e-8 -8.605825385643584e-9 -2.224122545158025e-5 -4.934626122121699e-5 1.3890294212615117e-5 8.351282303920016e-6 -7.481592911062762e-5 -0.00010948144335998222 -0.0001155473873950541 7.136596832424402e-5 8.196841372409835e-5 3.4320833947276697e-5 -0.00015645318489987403; -0.000156056325067766 -4.8536887334194034e-5 -6.917736754985526e-5 -1.9681787307490595e-5 -5.740669439546764e-5 0.00019544886890798807 -1.9588571376516484e-5 3.235770418541506e-5 3.704494156409055e-5 0.00016359853907488286 -0.00010079887579195201 9.506330388830975e-5 -5.4897955124033615e-5 6.514952110592276e-5 -1.060101294569904e-5 -7.002199708949775e-5 -7.57295565563254e-5 0.00020171605865471065 -0.00010438324534334242 9.664454410085455e-6 -2.226974356744904e-5 4.530013757175766e-5 -0.00013259236584417522 3.9665999793214723e-5 8.614644320914522e-5 -0.00017440313240513206 2.3471800886909477e-5 1.9183501080988208e-6 5.737554965890013e-5 -6.157703319331631e-5 -1.8908542642748216e-6 1.8752474716166034e-5; 3.691193705890328e-5 -2.0249744920874946e-5 4.8937923565972596e-5 1.8896918845712207e-5 -2.359584868827369e-5 1.6407657312811352e-5 -7.0648306973453145e-6 0.00012878696725238115 4.544792682281695e-5 -4.1431496356381103e-5 -5.574608803726733e-5 -0.0001392541453242302 -0.0001223289145855233 -6.932470153486747e-9 0.00015672465087845922 3.882027885993011e-5 -3.709816883201711e-5 -0.00021258735796436667 -0.00012653172598220408 7.17558796168305e-5 -0.00016025369404815137 2.542911533964798e-5 -9.170661360258237e-5 0.00014078043750487268 7.244382140925154e-5 5.668565790983848e-6 2.8658694645855576e-5 6.822896466474049e-6 2.451454747642856e-5 -0.00014489193563349545 -0.00017932783521246165 -5.8901427109958604e-5; -4.6386223402805626e-5 -6.086070425226353e-5 8.048283780226484e-5 2.1832933271070942e-5 4.744352918351069e-5 -0.00011213843390578404 -1.862178396550007e-5 0.00010329778160667047 9.984531061490998e-6 -5.199171937420033e-5 4.2696705349953845e-5 -5.261174374027178e-5 -4.1505383705953136e-5 -3.5900335205951706e-5 -0.0001444426889065653 -8.856961358105764e-5 -1.0534245120652486e-5 3.784748332691379e-5 -3.2229705539066344e-5 3.0168337616487406e-5 -0.00013453260180540383 -6.407657929230481e-5 3.6251908568374347e-6 6.703761027893052e-5 -6.162551289889961e-5 9.776994556887075e-5 2.4162398403859697e-5 -8.516098750988021e-5 -5.6009532272582874e-5 -6.87483225192409e-6 -8.843716932460666e-5 -2.614286495372653e-5; 0.00010494230082258582 -1.9320836145197973e-5 0.00019118750060442835 9.179779590340331e-5 2.0093517377972603e-5 0.00016448795213364065 -1.1491818440845236e-5 -0.00011025214189430699 -0.000173962747794576 -9.05416818568483e-5 3.5456192563287914e-5 0.00010305416071787477 0.0001443552173441276 3.864058817271143e-5 8.942361455410719e-5 -1.31597362269531e-5 -0.00020133063662797213 3.0125778721412644e-5 -0.0001311347441514954 -6.082383947614289e-7 -0.00012468951172195375 0.00023534476349595934 3.7558354961220175e-5 -0.0002164313045796007 2.0939387468388304e-5 5.514547956408933e-5 5.78555918764323e-5 -5.5885066103655845e-6 -0.00026012209127657115 3.601279968279414e-5 -5.309632979333401e-5 -0.00015933557006064802; -4.7182584239635617e-5 4.125779014430009e-5 -6.721552199451253e-5 -0.00011061540863011032 -5.6131291785277426e-5 -4.8084799345815554e-5 -0.00013520802895072848 -9.57595602812944e-6 1.733258795866277e-5 5.115375188324833e-6 8.210031955968589e-5 7.667028967262013e-7 -0.00010912325524259359 -1.5819203326827846e-5 -3.367067620274611e-6 -1.984194022952579e-5 4.290124707040377e-5 9.455858526052907e-5 -2.646843859110959e-5 0.00016821830649860203 0.00019511058053467423 6.531168764922768e-5 -2.629560640343698e-7 0.00018433605146128684 7.468427793355659e-5 -3.364962321938947e-5 -0.00015023571904748678 -4.263799200998619e-5 5.2966188377467915e-5 0.00011054579954361543 -7.666008605156094e-5 -0.00013314728857949376; 0.0002042801061179489 0.00015432885265909135 6.141418270999566e-5 -1.3649479114974383e-5 0.00010098001075675711 7.552289753220975e-5 5.301450073602609e-5 3.0376648282981478e-5 4.956984776072204e-5 -0.00016238211537711322 0.00016818534641060978 -7.559409277746454e-5 6.793704233132303e-5 7.451772398781031e-5 -0.00012030790821881965 7.752267265459523e-5 -6.229987047845498e-5 1.826504922064487e-5 0.00015292881289497018 3.2460716283821966e-6 8.294339204439893e-5 -0.00015690081636421382 -9.238830534741282e-5 -0.00010832231055246666 -4.599532621796243e-5 -1.5530096789007075e-5 -7.611690671183169e-5 -3.7676029023714364e-5 -0.0002883795532397926 4.552401151158847e-5 1.1340382116031833e-5 2.753768967522774e-5; -5.180163134355098e-5 -7.965965050971135e-5 -6.362889689626172e-5 0.00011203119356650859 0.00014725886285305023 9.079295705305412e-5 -1.6436550140497275e-5 -7.902943616500124e-5 -8.417786011705175e-5 -2.0070619939360768e-5 2.3933350803417852e-6 -0.00010855971049750224 0.00012287938443478197 -0.00010461398778716102 2.1182759155635722e-5 -8.919004176277667e-5 -4.412245107232593e-5 0.00018989272939506918 -4.141811223234981e-5 8.241410250775516e-5 -6.246986595215276e-5 -1.1070267646573484e-5 -4.972620808985084e-5 -0.0002964937884826213 0.00015145275392569602 -3.105693031102419e-5 -6.039319123374298e-5 -0.00012014312233077362 -0.00014765741070732474 6.702148675685748e-5 -0.00015618874749634415 -4.726179031422362e-5; 0.00014614054816775024 9.023365237226244e-6 0.00013161635433789343 6.299369124462828e-5 -0.00014668864605482668 -6.309527816483751e-5 0.00010497682524146512 1.017491285892902e-5 2.031346593867056e-5 -0.00012038150453008711 0.00019927900575567037 -0.00010012544953497127 6.417175882234005e-6 0.0002926999004557729 3.283246041974053e-5 -4.910640200250782e-6 -0.00015280095976777375 0.00010719692363636568 -5.794689423055388e-5 0.00010441674385219812 0.00013830514217261225 0.00022305807215161622 -8.975477248895913e-5 8.108191832434386e-5 7.126724813133478e-5 -1.1322040904815367e-7 1.753755714162253e-5 2.650452370289713e-5 6.730855238856748e-5 -7.607986481161788e-5 -0.00017479223606642336 6.218693306436762e-5; -5.3352890972746536e-5 5.1456187065923586e-5 0.0001594450877746567 -1.4313991414383054e-5 0.00021809875033795834 -8.476367656840011e-5 2.7938369385083206e-5 -8.826027624309063e-5 -3.1603740353602916e-5 -0.00018150378309655935 -7.248718611663207e-5 6.528565427288413e-5 -2.7563604817260057e-5 -7.205779547803104e-5 0.00013625014980789274 -4.569781958707608e-5 2.029180723184254e-5 0.00013982139353174716 5.004258127883077e-5 -0.000135241134557873 -4.6846082113916054e-5 0.00017274392303079367 -7.740484579699114e-5 -6.204059900483117e-5 -3.858151103486307e-5 -0.00014839519280940294 9.779076935956255e-5 -0.0001318193244514987 4.994043047190644e-5 0.00013576632773038 -2.641654464241583e-5 9.569433314027265e-5; -9.929692168952897e-5 5.884894198970869e-5 -0.00010578367073321715 8.185277692973614e-5 -0.00014698406448587775 -2.4869959815987386e-5 8.536226232536137e-5 -3.668971112347208e-5 4.9241058150073513e-5 4.811562757822685e-5 0.00010880323679884896 3.876857226714492e-5 -0.0001555757480673492 1.903890552057419e-5 -7.102516246959567e-5 -0.00012723004329018295 -0.0001669835764914751 3.6911233110004105e-6 -9.361282718600705e-5 8.187374623958021e-5 -2.083613071590662e-5 -5.347319893189706e-5 -4.633488424587995e-5 1.8068471035803668e-5 8.603342575952411e-5 4.4285312469583005e-5 3.517596633173525e-5 -9.350178152089939e-5 2.5058221581275575e-5 0.00012974903802387416 -0.0001960617519216612 0.0001047568439389579; -5.2155191951896995e-5 1.743900793371722e-5 -9.624553786125034e-5 -3.293944973847829e-5 -3.919837035937235e-5 -6.315439532045275e-5 -7.625151192769408e-5 -3.863884921884164e-5 -3.007322084158659e-5 9.901191515382379e-5 4.7158569941530004e-5 -5.079368202132173e-5 2.6940824682242237e-5 -2.910142211476341e-5 2.575915277702734e-5 -0.00014217464195098728 -0.00012184030492790043 -2.7388590751797892e-5 6.387582834577188e-5 9.754383791005239e-5 -5.2122155466349795e-5 0.00015790002362336963 0.0002236914588138461 -3.1224794838635717e-6 0.00016382256580982357 -2.521976421121508e-5 0.00014337203174363822 6.208756985870423e-6 -0.00013456304441206157 -5.805791079183109e-5 -0.00016737869009375572 -0.00011958972754655406; 0.00011991203791694716 -4.760159572470002e-5 -4.0916173020377755e-5 -7.534282485721633e-5 -0.0002116691757692024 0.00014308217214420438 9.906729974318296e-5 9.967540972866118e-5 0.00023327833332587034 0.00011185998300788924 7.658197864657268e-5 7.365517262769572e-7 0.000253996899118647 8.758402691455558e-5 -5.698854693036992e-6 0.00012242223601788282 -0.00013695760571863502 3.967698830820154e-6 0.0001518166100140661 4.7648961754021e-7 -8.375725883524865e-5 -0.00014174633543007076 -4.570677629089914e-5 0.0001256498508155346 3.26864501403179e-5 -7.58948881411925e-5 -0.0001635729131521657 -1.8859528836401296e-6 -4.708050619228743e-5 -7.948261190904304e-5 0.00010416575969429687 7.44918736472755e-7; 1.0104239663633052e-5 5.0169150199508294e-5 0.00013413254055194557 -0.00014330967678688467 -0.0001859063922893256 -0.00013254588702693582 -1.7167747500934638e-5 -0.00012677322956733406 -4.2868618038482964e-5 -5.512332063517533e-5 -2.447396400384605e-5 -5.619657531497069e-5 8.792067819740623e-5 0.00011685045319609344 3.8914895412744954e-5 7.726855983491987e-5 -9.482385212322697e-5 0.0001352429244434461 1.3161544302420225e-5 -3.4151413274230435e-5 0.00013466189557220787 3.926878889615182e-6 -1.1609075954766013e-5 -9.84712241915986e-5 -3.208184352843091e-5 2.8867074433946982e-5 -3.425726026762277e-5 -1.7970100088859908e-5 4.6322642447194085e-5 -6.606266833841801e-5 -4.7284709580708295e-5 -7.997830834938213e-5; -4.454858571989462e-5 2.3000693545327522e-5 -8.395168697461486e-5 -1.682906713540433e-6 -9.764193237060681e-5 8.721619087737054e-5 6.550131365656853e-5 -7.34254572307691e-5 8.855276246322319e-5 0.0002518374240025878 8.307113603223115e-6 0.00016308364865835756 0.00020704351481981575 8.797008194960654e-5 -8.959967090049759e-5 -0.00015837997489143163 -9.353389032185078e-5 -8.381086809094995e-5 -1.6316593246301636e-5 -6.225003016879782e-5 -2.2633548724115826e-5 3.303827179479413e-5 -6.592542922589928e-5 0.00013214566570241004 -0.00022957674809731543 -4.9836573452921584e-5 0.000131760083604604 0.000186096309334971 8.633198740426451e-5 5.229944144957699e-5 -2.7468391635920852e-5 1.9956632968387567e-5; -3.6354351323097944e-5 7.505757093895227e-5 -3.380375710548833e-5 -0.00010047356772702187 6.0120779380667955e-5 0.00011809916031779721 5.674112617271021e-5 -5.9683799918275326e-5 5.2049264922970906e-5 -9.146599768428132e-5 -0.00011707489466061816 -0.00013213057536631823 4.5186436182120815e-5 7.820413156878203e-5 -2.666441105247941e-5 1.1667349099298008e-5 -3.7675003113690764e-5 4.3827105400850996e-5 -3.0837814847473055e-5 7.35217472538352e-5 -3.603852746891789e-5 -4.798991540155839e-6 -0.00011211181845283136 0.00011256983270868659 0.00016209665045607835 -0.00010359336010878906 -9.102966942009516e-6 6.907589704496786e-5 0.00011623352474998683 -0.0001136086939368397 -0.00015249697025865316 -9.311082249041647e-5; 0.00013778716675005853 0.0001048565172823146 -0.0001663931761868298 -8.1649974163156e-5 2.310560921614524e-5 -0.00014349323464557528 -0.0001564939448144287 1.8482360246707685e-6 6.167053652461618e-5 8.857403736328706e-5 1.471275209041778e-5 -1.6219457393162884e-5 -6.028869756846689e-5 -6.97638897690922e-5 5.209178198128939e-6 -5.115375188324833e-6 -6.154394941404462e-5 -0.0001710884680505842 0.00017083025886677206 4.1100269299931824e-5 1.3363457583182026e-5 -0.00016956296167336404 -3.3078067644964904e-5 -7.310629007406533e-5 -5.560788486036472e-5 -0.00010350167576689273 -4.297428313293494e-5 6.786615267628804e-5 7.276792166521773e-5 5.105202035338152e-6 -2.995050272147637e-5 -9.856865654001012e-5; 0.0001600372779648751 8.238674490712583e-5 0.00010805176134454086 -0.00012011040962534025 -6.344526627799496e-5 -4.606405855156481e-5 5.982254151604138e-5 -0.00022758809791412205 -0.0001536599884275347 -2.5799527065828443e-5 0.000131640859763138 3.991031553596258e-5 -0.00010848831152543426 0.00015392772911582142 2.225987918791361e-5 3.600151103455573e-5 0.00011179894499946386 8.69955838425085e-5 0.00015699992945883423 0.00016312941443175077 -1.0677162208594382e-5 -0.00016384405898861587 0.00016069455887190998 -1.3365839549805969e-5 -7.032614666968584e-5 7.637649832759053e-5 -0.0001097691201721318 -0.00018681965593714267 4.958055797033012e-5 1.0882621609198395e-5 2.6549774702289142e-5 0.000297360063996166; 2.9267182981129736e-5 3.991937774117105e-5 -0.00015442713629454374 0.00019673917267937213 -5.9157697251066566e-5 5.1471775805111974e-5 -6.458307325374335e-5 4.877779065282084e-5 9.711979146231897e-6 -3.793586802203208e-5 -7.135925989132375e-5 0.00014953281788621098 2.04203934117686e-5 -7.29923922335729e-5 -9.592768765287474e-5 -7.38856615498662e-5 2.1973082766635343e-5 -8.607349445810542e-5 -2.5847968572634272e-5 1.588885970704723e-5 0.00016506249085068703 4.396085932967253e-5 -9.424537711311132e-5 4.1806575609371066e-5 5.4824526159791276e-5 4.313911995268427e-5 -3.554017894202843e-5 0.00018441519932821393 -3.817700417130254e-6 -0.00011723200441338122 1.3289444723341148e-5 0.00014734268188476562; 9.681548544904217e-5 0.00011356620234437287 -0.00028598535573109984 -0.0002573216916061938 0.00020086074073333293 5.827360655530356e-5 4.412768976180814e-5 2.5552804800099693e-5 -0.00011420615192037076 -0.00013350391236599535 -0.0001507631823187694 9.238936036126688e-5 -2.2205145796760917e-5 2.7342244720784947e-5 3.086793003603816e-5 5.378724745241925e-5 -0.00020701548783108592 -4.943555177305825e-5 4.267654367140494e-5 0.00021766596182715148 0.00019717002578545362 -0.00011825210094684735 7.555803313152865e-5 -0.00016949191922321916 -5.9303667512722313e-5 2.1757536160293967e-5 0.00016667907766532153 -0.0001529665314592421 -8.19233464426361e-5 -4.3355867092031986e-5 6.103290434111841e-5 0.00014051033940631896; 0.00012714463809970766 2.0806906832149252e-5 -4.359618105809204e-5 -0.00011601513688219711 1.0281453342031455e-6 -6.985149866522988e-6 9.845569729804993e-5 7.427047967212275e-5 -8.212677494157106e-5 -0.0002080648991977796 -6.309684249572456e-5 -9.690858132671565e-5 6.659428618149832e-5 -9.139710164163262e-5 -6.900369771756232e-5 -0.00012150147813372314 -2.8142281735199504e-5 1.0433350325911306e-5 4.215661101625301e-5 -2.0191006115055643e-5 8.421806705882773e-5 -0.00014103275316301733 -7.97912070993334e-5 0.00023446093837264925 -1.7687600120552815e-5 -4.36527407146059e-5 2.870269054255914e-5 -4.439044641912915e-5 -0.00015271622396539897 -0.00011724572686944157 -0.00013970467261970043 -8.060815162025392e-6; 2.3627681002835743e-5 9.801224950933829e-5 -9.95628724922426e-5 -0.00011898815864697099 5.086175588076003e-5 -5.334455272532068e-5 -4.5930697524454445e-5 -8.18773842183873e-5 -0.00010577635111985728 -1.3679520634468645e-5 9.239472274202853e-5 4.878684558207169e-5 -7.521806401200593e-5 -2.372211565671023e-5 1.2754323506669607e-5 -0.00010129819565918297 -0.00012213453010190278 5.361363218980841e-5 -7.047571557450283e-7 5.052533379057422e-5 -9.047538333106786e-5 -3.657914567156695e-5 0.0001965309784281999 -4.648969024856342e-6 7.898265175754204e-5 5.483286076923832e-5 9.152331040240824e-5 0.00026285031344741583 6.542312348756241e-6 -7.937761665743892e-7 -0.0002959125267807394 -2.04294997274701e-6; -0.00010841304901987314 -3.9703438233118504e-5 -0.00019324812456034124 0.00012656653416343033 4.5519536797655746e-5 -6.663121894234791e-5 8.802980300970376e-5 2.9608623663079925e-5 5.887992665520869e-5 -2.773659252852667e-5 3.5723264772968832e-6 -2.5985343654610915e-6 0.00022417255968321115 -0.0001133497353293933 0.00012366307782940567 -0.00012176532618468627 0.00016032851999625564 0.00010239607217954472 -0.00010678630496840924 -0.00021904680761508644 0.00010404887871118262 1.5584628272335976e-5 3.2846022804733366e-5 -7.331684901146218e-5 9.639747077017091e-6 -8.244020864367485e-5 4.580747554427944e-5 -4.756331327371299e-5 0.00010880880290642381 -0.0002107637992594391 2.6053021429106593e-5 4.185468060313724e-5; -1.4025503332959488e-5 1.517797227279516e-5 0.00014560877752956003 1.2378899555187672e-5 4.1024424717761576e-5 -2.7776155548053794e-5 -7.292325608432293e-5 5.1494054787326604e-5 6.933042459422722e-5 2.0214008600305533e-6 6.842926813988015e-5 4.0782611904433e-5 -2.642804020069889e-6 -2.6954490749631077e-5 3.169682895531878e-5 -3.69980298273731e-5 -1.532673923065886e-5 -0.0002120157441822812 5.232493276707828e-5 0.00010518613999010995 2.791721090034116e-5 0.00018741500389296561 -9.375732042826712e-5 -1.3830890566168819e-5 -0.00017523877613712102 0.0001437277824152261 -7.149095472414047e-5 -4.0803166484693065e-5 -0.0001761481398716569 -0.00013428970123641193 5.672027691616677e-5 0.00015795159561093897; 5.6344269978580996e-5 3.817124888882972e-5 3.039967850781977e-6 -5.13363593199756e-5 0.0001614778011571616 9.420643618796021e-5 -0.00013991612649988383 3.6863893910776824e-5 9.942038013832644e-5 -6.076392674003728e-5 8.937851816881448e-5 0.00017542389105074108 0.0001717058476060629 0.00010988791473209858 -7.2840057327994145e-6 4.5028271415503696e-5 -8.595950930612162e-5 -1.6330885046045296e-5 -2.5934230052371277e-6 1.3051024325250182e-5 -0.00015113870904315263 2.3132339265430346e-5 5.640591916744597e-5 0.00018645828822627664 -2.0957224478479475e-5 -0.00011576616816455498 -3.666436532512307e-5 7.077708141878247e-5 0.00035076745552942157 4.495086977840401e-5 5.814164615003392e-5 0.00014548985927831382; 1.3648062122229021e-5 -2.8239042876521125e-5 8.479569078190252e-5 -0.00018651118443813175 7.556228229077533e-5 -7.059022755129263e-5 -0.00014035165077075362 -1.4365737115440425e-5 -5.8196641475660726e-5 0.00010130957525689155 -3.408059637877159e-5 -0.00010764930630102754 1.7576459867996164e-5 0.00015525233175139874 -0.00014815577014815062 -5.6585206039017066e-5 6.598738400498405e-5 0.00011116287350887433 3.626463148975745e-5 0.00012833216169383377 -0.00017676576680969447 -0.00013504675007425249 1.675159546721261e-5 -6.746593135176226e-5 -0.0002883203560486436 -1.2429367416189052e-5 9.003984450828284e-5 0.00010260232375003397 -0.00013190436584409326 -2.0614726963685825e-5 -2.8493443096522242e-5 -0.00017396261682733893], bias = [0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0;;]), layer_4 = (weight = [2.9433117276767007e-8 -1.8128612282453105e-5 -0.00013661551929544657 -9.171198325930163e-5 -1.1328563232382294e-5 -1.3714418855670374e-5 2.198621405113954e-5 0.0001386743679177016 -0.00016722874715924263 5.936242450843565e-5 3.133690597678651e-6 3.6069840803065745e-7 -6.0280417528701946e-5 0.00014415687473956496 5.9815858548972756e-5 0.00014105724403634667 -0.00017218412540387362 6.776607915526256e-5 5.105320815346204e-5 -0.00018283961981069297 8.707754022907466e-5 7.543271203758195e-5 -9.036970004672185e-5 -0.00012496407725848258 -5.945949669694528e-5 -2.3181173673947342e-5 0.00013706661411561072 -1.1429376172600314e-5 8.394178439630195e-5 0.00016173211042769253 0.00012183565559098497 -7.036820170469582e-5; 0.0001063428062479943 -0.00014447644934989512 -5.0143869884777814e-5 6.010899960529059e-5 4.653951327782124e-5 0.00010324644244974479 0.00014337303582578897 2.0592871806002222e-5 -0.00012821581913158298 6.500653398688883e-5 -2.092832573907799e-6 1.318496470048558e-5 -3.365208976902068e-5 -5.2874998800689355e-5 -0.00013178699009586126 0.00016710175259504467 -3.6427365557756275e-5 -2.2760241336072795e-5 9.331521869171411e-5 -2.8405014745658264e-5 -4.5489578042179346e-5 7.340859883697703e-5 -9.366229642182589e-5 4.155740316491574e-5 -0.00011416841152822599 -9.922239405568689e-5 -7.363718032138422e-5 5.5289525334956124e-5 -0.00010958656639559194 -7.676885434193537e-5 2.3300501197809353e-5 -0.0001601759431650862], bias = [0.0; 0.0;;]))
```


Now we define a system of odes which describes motion of point like particle with Newtonian physics, uses


$$
u[1] = \chi
$$


$$
u[2] = \phi
$$


where, $p$, $M$, and $e$ are constants


```julia
function ODE_model(u, nn_params, t)
    χ, ϕ = u
    p, M, e = ode_model_params

    # In this example we know that `st` is am empty NamedTuple hence we can safely ignore
    # it, however, in general, we should use `st` to store the state of the neural network.
    y = 1 .+ first(nn([first(u)], nn_params, st))

    numer = (1 + e * cos(χ))^2
    denom = M * (p^(3 / 2))

    χ̇ = (numer / denom) * y[1]
    ϕ̇ = (numer / denom) * y[2]

    return [χ̇, ϕ̇]
end
```


```
ODE_model (generic function with 1 method)
```


Let us now simulate the neural network model and plot the results. We'll use the untrained neural network parameters to simulate the model.


```julia
prob_nn = ODEProblem(ODE_model, u0, tspan, params)
soln_nn = Array(solve(prob_nn, RK4(); u0, p=params, saveat=tsteps, dt, adaptive=false))
waveform_nn = first(compute_waveform(dt_data, soln_nn, mass_ratio, ode_model_params))

fig = with_theme(theme_web()) do
    fig = Figure()
    ax = CairoMakie.Axis(fig[1, 1]; xlabel="Time", ylabel="Waveform")

    l1 = lines!(ax, tsteps, waveform; linewidth=2, alpha=0.75)
    s1 = scatter!(ax, tsteps, waveform; markershape=:circle, markeralpha=0.25, alpha=0.5)

    l2 = lines!(ax, tsteps, waveform_nn; linewidth=2, alpha=0.75)
    s2 = scatter!(ax, tsteps, waveform_nn; markershape=:circle, markeralpha=0.25, alpha=0.5)

    axislegend(ax, [[l1, s1], [l2, s2]],
        ["Waveform Data", "Waveform Neural Net (Untrained)"]; position=:lb)

    return fig
end
```


![](1_GravitationalWaveForm-35.png)


<a id='Setting-Up-for-Training-the-Neural-Network'></a>

## Setting Up for Training the Neural Network


Next, we define the objective (loss) function to be minimized when training the neural differential equations.


```julia
function loss(θ)
    pred = Array(solve(prob_nn, RK4(); u0, p=θ, saveat=tsteps, dt, adaptive=false))
    pred_waveform = first(compute_waveform(dt_data, pred, mass_ratio, ode_model_params))
    loss = sum(abs2, waveform .- pred_waveform)
    return loss, pred_waveform
end
```


```
loss (generic function with 1 method)
```


Warmup the loss function


```julia
loss(params)
```


```
(0.17893987202014994, [-0.02425081505149754, -0.02346678566806034, -0.022682756284622792, -0.02135798506502346, -0.01946473185718717, -0.016962726118050414, -0.013799087428815438, -0.009905354347368639, -0.005199740399504967, 0.00041323286777406, 0.0070335473936661095, 0.014744744222475138, 0.023566265851095034, 0.03332480812168219, 0.04337521335855644, 0.05194010590640924, 0.054712617490478975, 0.04258104227682235, 0.0019915472905992072, -0.06628802580211568, -0.11021502639045118, -0.07624863007591944, -0.00704381864959422, 0.03847452390300651, 0.053984428692453804, 0.05278364868936832, 0.04479901727649341, 0.03487883480474361, 0.025060440756604522, 0.016108217269289588, 0.00824286109752295, 0.001468592609920214, -0.004291029681473858, -0.009133740216571339, -0.01315520814051509, -0.01643764729330938, -0.019051126949640045, -0.021050401453632173, -0.022477003705679875, -0.023360072455251544, -0.023717277801126858, -0.023555134055490548, -0.0228702068169547, -0.021646815895466465, -0.01985900233704096, -0.017468204586412912, -0.01442239598126322, -0.01065542603359655, -0.006086103768042961, -0.0006195430351969317, 0.005845600205983444, 0.013401535055124193, 0.02208319648218101, 0.031764232776376196, 0.04190154867448425, 0.05095198008053964, 0.055101428348367586, 0.046047190430268545, 0.010349770978600558, -0.05580542942554464, -0.10827484617177838, -0.08540295529316329, -0.01668449979313432, 0.033691593133016305, 0.05287931585039639, 0.05346099514782658, 0.046163053017644354, 0.03642090242826788, 0.02656390746273135, 0.017490378426140187, 0.009472909106880659, 0.0025476689094736226, -0.0033616899818858376, -0.008339905478865449, -0.012491351608179393, -0.015891601097629507, -0.018619047744150328, -0.020723443347091478, -0.022253248735092757, -0.023234901466113636, -0.023690158470129168, -0.02362576709711522, -0.023038793579324018, -0.021916717342178395, -0.02023480046591203, -0.01795285722837634, -0.01502618412293555, -0.011383021221356716, -0.0069512964204693885, -0.0016286664485881091, 0.004679599828963251, 0.012079099143913986, 0.020613148935812967, 0.030201945931510026, 0.04038653931443981, 0.04983840869615722, 0.055188509082189564, 0.0489159602552465, 0.017977993173217813, -0.04506748656293224, -0.10445925943705556, -0.09348487221468907, -0.026809050504419663, 0.028198742664132814, 0.05135551899398634, 0.053949079720916115, 0.04745542692963494, 0.03794503754399395, 0.028076358419842278, 0.018886781033798938, 0.010727589529933966, 0.0036450787048647845, -0.002406524334358699, -0.007527933407317371, -0.011803938367715695, -0.015328368999592938, -0.018165353610264355, -0.020379518885825232, -0.022009718969712756, -0.02309231775445739, -0.023644680504770938, -0.023677716453070163, -0.023189993668525956, -0.022167837971826792, -0.02059068330602954, -0.018418575263210685, -0.015608460672297098, -0.012090154399882147, -0.007793347711142772, -0.002615733472457511, 0.0035372851750017746, 0.010776812688540686, 0.01915982294440389, 0.02863963783991818, 0.03884015353596653, 0.04861677825824916, 0.05500500845314529, 0.051235752092975706, 0.02484483121446155, -0.0343083223915114, -0.09891298121911833, -0.10022702912416437, -0.037273072448655464, 0.021972222731198917, 0.049373371571968847, 0.05422091619080872, 0.048663700774483204, 0.03944751653020853, 0.029588637885375337, 0.02030402389333471, 0.01199895457854861, 0.004768250561545984, -0.0014355294414568776, -0.006688851745748708, -0.011099032058149499, -0.014742622831687565, -0.01769615848305949, -0.02001340650608626, -0.021749289866277142, -0.022930872523568284, -0.023581433498293763, -0.023711725687621303, -0.02332217114586887, -0.022401197722847127, -0.02092543603756616, -0.018866714670438458, -0.016169352542773276, -0.01277496814971135, -0.008613987175108601, -0.003581219830987215, 0.0024192770413997127, 0.009497677412216694, 0.017721764793432224, 0.027082043638604083, 0.03726911848155563, 0.047302195994461234, 0.054585469450829746, 0.05304741709692816, 0.030954410284672693, -0.023756075400855496, -0.09181691300299158, -0.10540115552172717, -0.04789883653065701, 0.015009973651220396, 0.04688224272791453, 0.05425188564063336, 0.04977343616135931, 0.04091764021081096, 0.031107823993886254, 0.021730634095710508, 0.013291552695349448, 0.0059091609270805505, -0.00043452841467977576, -0.0058341251316009176, -0.010372480234293081, -0.014139302686589271, -0.017202004875665894, -0.019632243040578295, -0.021469749251034058, -0.02275165183374658, -0.023499278337901795, -0.02372784521948506, -0.023436111715496553, -0.022614114302420694, -0.021245506432013582, -0.019291672970364288, -0.0167106828795242, -0.013439438906290199, -0.009411361711142225, -0.0045224747028216996, 0.001323776815274964, 0.008239435712433681, 0.01630403096138537, 0.02553225274888356, 0.035679065646013884, 0.04590970893607312, 0.05395576258403552, 0.05439901649483377, 0.036312987603548674, -0.013580195356354841, -0.08341520808107075, -0.10882405400767822, -0.05846194502891542, 0.0073102133983514814, 0.043846470679933025, 0.054007988197235145, 0.050768929453233066, 0.04235231784925519, 0.03262057061702502, 0.023171930270011385, 0.014602776241287162, 0.007073585185109753, 0.0005835796833935516, -0.004956012468764189, -0.00962509085256346, -0.013514437110002166, -0.0166917810596476, -0.019230551282451522, -0.02117175391174961, -0.02255392382609651, -0.023399557306585963, -0.023725556272734306, -0.02353174902718425, -0.02280965476284738, -0.021544032680291134, -0.019698243933742074, -0.017231514529091115, -0.014082640784576826, -0.010186553770352722, -0.006290466756128589])
```


Now let us define a callback function to store the loss over time


```julia
const losses = Float64[]

function callback(θ, l, pred_waveform)
    push!(losses, l)
    println("Training || Iteration: $(length(losses)) || Loss: $(l)")
    return false
end
```


```
callback (generic function with 1 method)
```


<a id='Training-the-Neural-Network'></a>

## Training the Neural Network


Training uses the BFGS optimizers. This seems to give good results because the Newtonian model seems to give a very good initial guess


```julia
adtype = Optimization.AutoZygote()
optf = Optimization.OptimizationFunction((x, p) -> loss(x), adtype)
optprob = Optimization.OptimizationProblem(optf, params)
res = Optimization.solve(optprob,
    BFGS(; initial_stepnorm=0.01, linesearch=LineSearches.BackTracking());
    callback, maxiters=1000)
```


```
u: ComponentVector{Float64}(layer_1 = Float64[], layer_2 = (weight = [-7.394809654210697e-5; 2.141996083082307e-5; 0.00017322218627663493; 8.316031744461057e-5; 0.00015331723261636143; 5.507153400676507e-5; -5.696482185155336e-5; 8.254934800784963e-5; -0.0001197269157272209; -1.9673439965113582e-5; 0.00014250735694052173; 9.394916560248499e-5; -5.654295455308051e-5; 5.326574682832123e-5; -6.518685495392537e-6; 1.250327500200552e-6; -9.356874215882276e-5; 2.3220494767876515e-5; -0.00014736338926004633; -8.056437764028742e-6; 2.617220889077487e-5; -4.837011510966485e-5; -2.144998506991243e-5; 8.767790859553485e-5; 0.00018672221631280497; 0.00016392074758192086; -8.057516242848716e-5; 2.6177898689619372e-5; 4.0547653043084984e-5; 4.8570286708119e-6; 0.0001535906485511399; 6.810646482319236e-6;;], bias = [-5.2901830868960126e-17; 3.55501145234777e-18; 6.378679544780733e-17; 1.1337176309899464e-16; -1.331210809055418e-16; 1.0412612034360122e-16; -3.126014778545773e-17; 4.25271703997989e-17; -1.673563992885307e-16; -4.380868389636437e-18; 2.8179133157417346e-16; 2.2273027215616425e-16; -8.064224892886429e-17; 9.126962772472288e-17; -1.1973439303484607e-18; 1.4374807462655398e-18; -8.831568997752255e-19; 8.591770341707855e-18; -1.0064213034653047e-16; 3.478493693708442e-18; 1.1854697326641327e-17; -6.333141692765961e-17; -1.003533540335517e-17; 1.3253588179940628e-16; -3.0882926847337556e-17; -5.617367539678403e-17; 6.453940294824124e-17; 2.1885018684368677e-17; 1.0446536600664571e-16; 9.576239463875434e-19; 3.782236472948369e-16; 1.906866351754483e-17;;]), layer_3 = (weight = [7.315514949126408e-5 -6.5808262685726186e-6 0.0001477309938285221 -0.0002887168434450923 -1.0110481982922394e-5 -0.0002372659714662099 -2.686691959994837e-5 -0.00028957639597380154 -0.00011877678344049258 4.7200448077392656e-5 -0.00012647099220216353 -0.00013914803867251952 -0.00010128739677626635 0.00011752333511806991 6.914773393630657e-5 0.00012401365665694363 -0.00010261213037907493 -0.00015848861085275461 -6.865175100997019e-5 -1.8394852761657418e-5 0.00011043076801554976 5.873863619611513e-5 -2.4028499889658053e-6 2.3254063760158667e-5 -4.288663558566432e-5 1.7206511526966036e-5 -3.096335285832758e-5 7.80863570046958e-5 8.19153224232032e-5 0.00010560382497472364 -0.00013177222581602367 6.097138384332555e-5; -5.4823131971558654e-5 0.00010185888907123868 -3.32377667962872e-5 2.6210996044185964e-5 0.00010607936649300848 -0.0001168461377108789 -6.7580985227166e-5 -0.00010291470159593408 0.0002639163512196081 -0.0001883906580349752 7.286011616649772e-5 -9.049077629084998e-6 -0.0001903006696682743 -9.311759288967989e-7 -3.0756494264849055e-5 9.301032780619846e-5 2.623991251873427e-5 -0.00013713721188999203 -1.032956628319454e-6 -0.00021829506210799753 7.916929546461023e-5 -8.014747352156262e-5 -0.00011141416241464625 0.00012581844287176246 5.38107678277589e-5 4.40552948258982e-5 0.00010485643808913044 9.078544910714544e-5 -1.0248563807024084e-5 -7.02556927297586e-5 4.9616203729032926e-5 0.0001266066473601064; -6.447923995925286e-5 0.0002127329407036464 -0.00011361741970663553 -6.847865923678643e-5 0.00017706351892652196 2.0358283940951914e-5 -7.419377114761839e-5 -0.00017830424811596192 0.00013677278722265752 1.587663420163283e-5 7.552360867943754e-5 -4.894593629192662e-5 -3.544667750735054e-5 -7.384873068563866e-5 -1.3591423417309351e-5 8.303729365674493e-5 -3.660393675577929e-5 -0.00012410384996233776 -2.8280354022493785e-5 9.593770474988683e-5 3.383868708137151e-5 1.528253771051994e-5 1.6927777246238696e-5 6.184256009386728e-5 -0.00011489271317746051 -7.520398693063954e-5 4.497539513490013e-5 -0.00016260539458504212 -3.9487380568387625e-5 0.00010241986994027805 -0.00013108597530422526 0.00013131788538397942; 1.9965740833224105e-5 -3.200229893692078e-5 5.6431210426048875e-6 -2.6573368628949578e-5 0.0001509317773555191 0.0001323594444359442 -0.00012138797664802766 -3.887110487695104e-5 0.00017294400841209772 0.00012102481942137464 -6.167741575764768e-5 0.00011137219208039089 9.636897830504679e-5 7.275629123186448e-5 5.605650315639734e-6 -1.9764789428070716e-5 -1.913053874587429e-5 -9.917516926789897e-5 -6.462296350647043e-5 0.0001055933864366053 -4.6830704987580335e-7 -0.00029858269026290855 9.06717870778194e-5 0.0001236952341089745 -1.4454993831085266e-5 -6.8511456417658705e-6 -2.6349134529216856e-5 -1.747078003673589e-5 -1.091361791323647e-5 -0.00016121604475911945 -9.47483276532546e-6 -0.00016622538150541722; 2.621687408106234e-5 0.00014756617738027536 -0.0001057718401206683 0.00011427840208495303 5.125968154612818e-5 0.00011977051317086796 6.414376539038842e-5 0.00022525808153301744 -6.016162306326345e-5 -7.180660768784168e-5 -9.562734349304848e-5 -4.860989802540057e-5 -5.849356248648488e-5 7.139002254559083e-5 -2.346926531020597e-5 -6.53064126744824e-5 3.088441726146489e-5 -3.3162068670145794e-5 0.000158833914516493 -1.8783108411236188e-5 -1.9860357591761875e-5 -0.0001485795147381686 7.523707599472668e-5 3.0595863696423044e-5 -0.00012988589160517226 -3.094045687606745e-5 -2.5382132756870288e-5 9.312663305178691e-5 -5.9406036692900454e-5 -3.507770461868073e-5 2.5858516797655074e-5 -3.346087405946616e-5; -3.926493698363182e-6 2.1047050288194738e-5 7.806882833600042e-5 4.475159268828217e-5 7.992754446811477e-5 -0.00011510971624169682 7.534043881811034e-5 5.336691585604203e-5 -3.1514809486663705e-5 -8.596294308312622e-5 -7.697051430816568e-5 3.985653213227424e-5 2.5671443129418563e-6 -2.0324190225202707e-5 -4.038641007150003e-5 -6.954667285548936e-5 0.00021981979855105528 -2.9363972751292395e-5 -6.97342543187242e-5 1.5222701697217412e-5 -9.42323526739924e-5 -5.4017811160285515e-5 -4.9074532833168346e-5 -1.2105434032253164e-5 0.00011316538486633813 8.568802197467295e-5 -5.9585406668464806e-5 -0.0001629398388811237 -0.00012547260073710525 -8.098812347975038e-5 -5.571105018836937e-5 -0.00016339058445532286; 3.6072347545527096e-5 6.37099524897004e-5 -1.551982171122854e-5 8.410277366009237e-5 -3.408565174368847e-5 7.846827208366736e-5 -5.039009859062199e-6 0.00012697200287901486 6.593395079788714e-5 -0.000135750530200783 -2.525136954546728e-5 -7.508405399904821e-5 1.796262546802899e-5 3.698502911673409e-5 0.0001218135963131153 -0.00015241774093057586 -0.00019308803023933673 -5.9222666488965725e-5 0.00011049692836194527 1.6472982179676092e-8 -9.703069368632864e-9 -2.2242322695562645e-5 -4.934735846520007e-5 1.388919696863465e-5 8.350185059949332e-6 -7.481702635460119e-5 -0.00010948254060396312 -0.00011554848463903707 7.136487108026138e-5 8.196731648011513e-5 3.431973670330196e-5 -0.00015645428214385729; -0.00015605677012945666 -4.8537332395885406e-5 -6.917781261154235e-5 -1.968223236918104e-5 -5.740713945715568e-5 0.0001954484238462971 -1.958901643820746e-5 3.23572591237246e-5 3.704449650240118e-5 0.0001635980940131915 -0.00010079932085364054 9.506285882661958e-5 -5.4898400185724594e-5 6.514907604423173e-5 -1.060145800739048e-5 -7.002244215118918e-5 -7.573000161801559e-5 0.00020171561359301932 -0.00010438369040503073 9.664009348394018e-6 -2.227018862914039e-5 4.529969251006656e-5 -0.00013259281090586658 3.966555473152439e-5 8.614599814745882e-5 -0.00017440357746681962 2.347135582521897e-5 1.917905046407474e-6 5.7375104597208924e-5 -6.157747825500775e-5 -1.891299325962854e-6 1.8752029654474595e-5; 3.6909729612722414e-5 -2.0251952367059428e-5 4.893571611980948e-5 1.889471139953239e-5 -2.359805613444149e-5 1.6405449866628737e-5 -7.067038143527781e-6 0.00012878475980620125 4.544571937664251e-5 -4.143370380256564e-5 -5.5748295483437444e-5 -0.0001392563527704086 -0.00012233112203170583 -9.139916336247916e-9 0.00015672244343227444 3.881807141374529e-5 -3.7100376278195594e-5 -0.00021258956541055112 -0.0001265339334283732 7.175367217064574e-5 -0.0001602559014943357 2.5426907893464855e-5 -9.170882104876683e-5 0.00014077823005869344 7.244161396309196e-5 5.666358344818474e-6 2.8656487199675454e-5 6.820689020289731e-6 2.4512340030244936e-5 -0.00014489414307968025 -0.00017933004265862937 -5.890363455614338e-5; -4.638889498527472e-5 -6.0863375834737e-5 8.048016621981714e-5 2.1830261688603115e-5 4.7440857601057355e-5 -0.00011214110548825524 -1.86244555479711e-5 0.00010329511002420254 9.981859479029652e-6 -5.199439095667386e-5 4.269403376749772e-5 -5.2614415322737933e-5 -4.150805528842421e-5 -3.590300678842309e-5 -0.00014444536048903914 -8.857228516353148e-5 -1.0536916703118701e-5 3.7844811744440395e-5 -3.223237712152124e-5 3.0165666034013606e-5 -0.0001345352733878771 -6.407925087477661e-5 3.6225192743639763e-6 6.703493869646336e-5 -6.162818448134304e-5 9.776727398642036e-5 2.4159726821391504e-5 -8.516365909235349e-5 -5.60122038550553e-5 -6.877503834397928e-6 -8.843984090705993e-5 -2.6145536536200347e-5; 0.00010494183389680265 -1.9321303070981895e-5 0.00019118703367864895 9.179732897762038e-5 2.0093050452192194e-5 0.0001644874852078571 -1.149228536662874e-5 -0.00011025260882008994 -0.00017396321472035777 -9.054214878263224e-5 3.545572563750702e-5 0.00010305369379209211 0.00014435475041834408 3.864012124692787e-5 8.94231476283232e-5 -1.3160203152737098e-5 -0.0002013311035537548 3.0125311795628735e-5 -0.0001311352110772761 -6.087053205454159e-7 -0.00012468997864773765 0.0002353442965701757 3.755788803543625e-5 -0.00021643177150538353 2.0938920542609626e-5 5.5145012638309434e-5 5.7855124950649295e-5 -5.588973536149476e-6 -0.00026012255820235484 3.6012332757010145e-5 -5.30967967191144e-5 -0.000159336036986432; -4.718238097135568e-5 4.125799341258037e-5 -6.721531872623425e-5 -0.00011061520536183051 -5.613108851699869e-5 -4.808459607753545e-5 -0.00013520782568244842 -9.575752759849592e-6 1.7332791226942122e-5 5.115578456605109e-6 8.210052282796482e-5 7.669061650059155e-7 -0.0001091230519743135 -1.5819000058547733e-5 -3.366864351994312e-6 -1.9841736961245493e-5 4.2901450338683494e-5 9.455878852880932e-5 -2.646823532283073e-5 0.00016821850976688228 0.00019511078380295445 6.53118909175078e-5 -2.627527957540996e-7 0.00018433625472956663 7.468448120183456e-5 -3.364941995111095e-5 -0.00015023551577920692 -4.263778874170593e-5 5.2966391645748114e-5 0.0001105460028118957 -7.665988278328221e-5 -0.0001331470853112135; 0.0002042809290839464 0.00015432967562509022 6.141500567598656e-5 -1.3648656148977268e-5 0.00010098083372274977 7.552372049820792e-5 5.3015323702024197e-5 3.0377471248978615e-5 4.957067072671716e-5 -0.00016238129241111433 0.00016818616937660326 -7.559326981146793e-5 6.793786529732114e-5 7.451854695380852e-5 -0.00012030708525282068 7.752349562059422e-5 -6.229904751245837e-5 1.8265872186643704e-5 0.00015292963586096327 3.246894594381158e-6 8.294421501039773e-5 -0.00015689999339821544 -9.238748238141397e-5 -0.00010832148758646976 -4.599450325197285e-5 -1.5529273823015335e-5 -7.611608374583445e-5 -3.767520605771556e-5 -0.0002883787302737941 4.5524834477587447e-5 1.134120508202446e-5 2.7538512641226706e-5; -5.180488557347028e-5 -7.966290473963595e-5 -6.363215112615512e-5 0.0001120279393365908 0.00014725560862314995 9.078970282313225e-5 -1.643980437041892e-5 -7.903269039491914e-5 -8.41811143469617e-5 -2.007387416928543e-5 2.390080850438147e-6 -0.000108562964727418 0.0001228761302048603 -0.0001046172420170831 2.117950492571069e-5 -8.919329599270173e-5 -4.4125705302241756e-5 0.00018988947516514472 -4.1421366462251964e-5 8.241084827783016e-5 -6.247312018207712e-5 -1.1073521876496086e-5 -4.972946231977543e-5 -0.0002964970427125383 0.00015144949969580774 -3.1060184540920906e-5 -6.039644546366119e-5 -0.00012014637656069799 -0.00014766066493724806 6.701823252693246e-5 -0.00015619200172624432 -4.7265044544148645e-5; 0.00014614439653320337 9.027213602685642e-6 0.00013162020270331598 6.29975396100796e-5 -0.00014668479768939607 -6.309142979938133e-5 0.00010498067360692104 1.017876122438048e-5 2.0317314304112625e-5 -0.00012037765616462763 0.00019928285412110499 -0.00010012160116952231 6.421024247689983e-6 0.0002927037488212292 3.2836308785200455e-5 -4.906791834790812e-6 -0.00015279711140232474 0.00010720077200182497 -5.7943045865121045e-5 0.00010442059221765799 0.0001383089905380714 0.00022306192051707328 -8.975092412349976e-5 8.108576668979421e-5 7.12710964967512e-5 -1.093720436217469e-7 1.7541405507074388e-5 2.6508372068356252e-5 6.73124007540254e-5 -7.607601644615796e-5 -0.0001747883877009928 6.219078142982752e-5; -5.335255161635812e-5 5.145652642231255e-5 0.00015944542713104242 -1.4313652057994801e-5 0.00021809908969434478 -8.476333721201144e-5 2.7938708741471862e-5 -8.825993688670237e-5 -3.1603400997215477e-5 -0.00018150344374017033 -7.248684676024532e-5 6.528599362927217e-5 -2.7563265460871394e-5 -7.205745612164233e-5 0.00013625048916428179 -4.569748023068707e-5 2.0292146588230586e-5 0.00013982173288813615 5.004292063521737e-5 -0.00013524079520148397 -4.6845742757527124e-5 0.00017274426238718247 -7.740450644060218e-5 -6.2040259648443e-5 -3.858117167847791e-5 -0.00014839485345301685 9.779110871595085e-5 -0.0001318189850951097 4.9940769828295274e-5 0.00013576666708676907 -2.641620528602943e-5 9.569467249666165e-5; -9.929858257853314e-5 5.8847281100701785e-5 -0.00010578533162220792 8.185111604073277e-5 -0.00014698572537487204 -2.4871620704992897e-5 8.536060143635598e-5 -3.6691372012475524e-5 4.9239397261074176e-5 4.81139666892199e-5 0.00010880157590985289 3.876691137814258e-5 -0.00015557740895635463 1.9037244631568574e-5 -7.102682335860281e-5 -0.0001272317041791901 -0.0001669852373804775 3.689462421993541e-6 -9.361448807500235e-5 8.187208535057309e-5 -2.0837791604913415e-5 -5.3474859820902936e-5 -4.6336545134886855e-5 1.8066810146800695e-5 8.603176487053597e-5 4.428365158059051e-5 3.517430544273164e-5 -9.350344240990618e-5 2.5056560692269305e-5 0.00012974737713486703 -0.00019606341281065543 0.00010475518304995076; -5.2156376414101305e-5 1.7437823471510977e-5 -9.62467223234452e-5 -3.294063420068203e-5 -3.91995548215697e-5 -6.315557978265801e-5 -7.625269638989925e-5 -3.864003368104542e-5 -3.0074405303787487e-5 9.901073069161754e-5 4.715738547933142e-5 -5.079486648352475e-5 2.6939640220037047e-5 -2.9102606576968735e-5 2.5757968314820932e-5 -0.00014217582641319366 -0.00012184148939010349 -2.7389775214004106e-5 6.387464388357384e-5 9.7542653447846e-5 -5.2123339928555955e-5 0.00015789883916116413 0.0002236902743516399 -3.123663946067028e-6 0.00016382138134763061 -2.5220948673411135e-5 0.0001433708472814343 6.207572523664265e-6 -0.00013456422887426735 -5.8059095254037515e-5 -0.00016737987455595304 -0.00011959091200876045; 0.00011991453007697581 -4.75991035646673e-5 -4.091368086036911e-5 -7.534033269718888e-5 -0.0002116666836091885 0.00014308466430423497 9.90697919032134e-5 9.96779018886887e-5 0.00023328082548589174 0.00011186247516792203 7.658447080658921e-5 7.390438863028645e-7 0.00025399939127867746 8.758651907458637e-5 -5.696362533003925e-6 0.00012242472817791596 -0.00013695511355860904 3.970190990852818e-6 0.00015181910217408146 4.789817775732601e-7 -8.37547666752161e-5 -0.00014174384327003952 -4.5704284130866426e-5 0.0001256523429755614 3.2688942300322585e-5 -7.589239598118129e-5 -0.00016357042099213791 -1.8834607236075858e-6 -4.7078014032255676e-5 -7.948011974900996e-5 0.00010416825185431075 7.474108965058193e-7; 1.0102567012333032e-5 5.016747754820552e-5 0.0001341308679006591 -0.0001433113494381839 -0.00018590806494061567 -0.0001325475596782372 -1.7169420152235883e-5 -0.00012677490221863334 -4.2870290689778104e-5 -5.5124993286478156e-5 -2.4475636655137902e-5 -5.619824796626886e-5 8.791900554610495e-5 0.00011684878054479194 3.891322276144195e-5 7.726688718361684e-5 -9.482552477452519e-5 0.00013524125179214334 1.315987165112915e-5 -3.415308592553343e-5 0.0001346602229209052 3.92520623831344e-6 -1.161074860606879e-5 -9.847289684289739e-5 -3.208351617971476e-5 2.8865401782658737e-5 -3.425893291892223e-5 -1.797177274016256e-5 4.632096979589196e-5 -6.606434098972102e-5 -4.7286382231998346e-5 -7.997998100068513e-5; -4.454683134454871e-5 2.300244792067628e-5 -8.394993259928293e-5 -1.6811523381953607e-6 -9.76401779952712e-5 8.721794525271783e-5 6.550306803191571e-5 -7.342370285542395e-5 8.8554516838564e-5 0.0002518391783779366 8.30886797856055e-6 0.00016308540303370153 0.00020704526919516293 8.797183632495395e-5 -8.959791652514857e-5 -0.00015837822051608264 -9.353213594650676e-5 -8.380911371560122e-5 -1.6314838870965005e-5 -6.224827579344882e-5 -2.2631794348767198e-5 3.304002617014181e-5 -6.592367485055051e-5 0.00013214742007775464 -0.00022957499372198628 -4.983481907758789e-5 0.0001317618379799493 0.0001860980637103196 8.63337417796126e-5 5.2301195824926e-5 -2.7466637260585292e-5 1.9958387343736558e-5; -3.635524031693913e-5 7.505668194510962e-5 -3.38046460993224e-5 -0.00010047445672086263 6.0119890386832e-5 0.00011809827132395533 5.674023717886838e-5 -5.968468891211614e-5 5.2048375929132306e-5 -9.1466886678124e-5 -0.00011707578365445503 -0.0001321314643601585 4.518554718827897e-5 7.820324257494008e-5 -2.666530004632218e-5 1.1666460105455227e-5 -3.7675892107531e-5 4.3826216407008385e-5 -3.083870384130953e-5 7.352085825999243e-5 -3.603941646276046e-5 -4.79988053399794e-6 -0.00011211270744667401 0.00011256894371484605 0.0001620957614622457 -0.00010359424910262404 -9.103855935850413e-6 6.907500805112526e-5 0.00011623263575614454 -0.00011360958293068249 -0.00015249785925248907 -9.311171148425924e-5; 0.00013778422647721465 0.0001048535770094659 -0.00016639611645965003 -8.165291443599846e-5 2.3102668943318714e-5 -0.00014349617491842145 -0.00015649688508727468 1.8452957518281973e-6 6.166759625178085e-5 8.857109709043831e-5 1.4709811817588182e-5 -1.6222397666003515e-5 -6.0291637841312946e-5 -6.976683004193862e-5 5.206237925279857e-6 -5.118315461173956e-6 -6.154688968688533e-5 -0.00017109140832343274 0.00017082731859394378 4.1097329027082763e-5 1.3360517310333561e-5 -0.00016956590194621088 -3.3081007917813585e-5 -7.310923034690707e-5 -5.561082513318032e-5 -0.00010350461603971603 -4.2977223405777824e-5 6.786321240343956e-5 7.276498139237017e-5 5.102261762489052e-6 -2.995344299430281e-5 -9.85715968128592e-5; 0.00016003979846567338 8.238926540792825e-5 0.00010805428184531878 -0.0001201078891245432 -6.344274577721165e-5 -4.606153805076453e-5 5.982506201684149e-5 -0.0002275855774133249 -0.00015365746792674376 -2.5797006565025962e-5 0.00013164338026392392 3.991283603675807e-5 -0.0001084857910246341 0.0001539302496166219 2.2262399688716377e-5 3.600403153535853e-5 0.00011180146550025939 8.699810434331084e-5 0.00015700244995961902 0.00016313193493255353 -1.0674641707792152e-5 -0.00016384153848781499 0.0001606970793727124 -1.3363319049009546e-5 -7.032362616891195e-5 7.637901882837103e-5 -0.00010976659967133439 -0.00018681713543634043 4.958307847113155e-5 1.0885142110001172e-5 2.6552295203072374e-5 0.0002973625844969687; 2.926833714127348e-5 3.992053190131669e-5 -0.00015442598213440925 0.00019674032683951532 -5.9156543090929617e-5 5.1472929965256635e-5 -6.458191909359875e-5 4.877894481296408e-5 9.713133306372304e-6 -3.793471386188642e-5 -7.135810573118558e-5 0.00014953397204635346 2.04215475719132e-5 -7.299123807342817e-5 -9.592653349272895e-5 -7.388450738972038e-5 2.1974236926777852e-5 -8.607234029795981e-5 -2.5846814412496646e-5 1.589001386719301e-5 0.00016506364501083255 4.3962013489817455e-5 -9.424422295296569e-5 4.1807729769513985e-5 5.482568031992394e-5 4.3140274112819964e-5 -3.5539024781885074e-5 0.00018441635348835945 -3.816546256985068e-6 -0.00011723085025323541 1.3290598883478067e-5 0.00014734383604491142; 9.68147550582848e-5 0.00011356547195361433 -0.0002859860861218514 -0.0002573224219969508 0.00020086001034257993 5.827287616454562e-5 4.412695937105025e-5 2.5552074409342662e-5 -0.000114206882311126 -0.00013350464275675388 -0.0001507639127095232 9.238862997051032e-5 -2.2205876187518815e-5 2.7341514330026968e-5 3.08671996452795e-5 5.378651706166058e-5 -0.0002070162182218425 -4.943628216381679e-5 4.267581328065145e-5 0.00021766523143639286 0.00019716929539469514 -0.00011825283133760544 7.555730274077011e-5 -0.00016949264961397598 -5.930439790347267e-5 2.175680576954171e-5 0.0001666783472745644 -0.00015296726185000059 -8.192407683339435e-5 -4.335659748279065e-5 6.1032173950365364e-5 0.00014050960901556032; 0.00012714086000790306 2.0803128740338496e-5 -4.35999591498666e-5 -0.00011601891497399995 1.0243672424206205e-6 -6.98892795833059e-6 9.845191920624259e-5 7.426670158031978e-5 -8.213055303336482e-5 -0.00020806867728959043 -6.310062058751102e-5 -9.691235941851616e-5 6.659050808969092e-5 -9.140087973344049e-5 -6.900747580937359e-5 -0.00012150525622553445 -2.81460598270001e-5 1.0429572234100648e-5 4.2152832924468294e-5 -2.0194784206866884e-5 8.421428896701723e-5 -0.0001410365312548258 -7.979498519114418e-5 0.00023445716028084736 -1.7691378212321427e-5 -4.3656518806384304e-5 2.8698912450755773e-5 -4.439422451093963e-5 -0.00015272000205720826 -0.00011724950496125287 -0.00013970845071148286 -8.064593253836653e-6; 2.3627070267668606e-5 9.801163877417014e-5 -9.956348322740484e-5 -0.00011898876938213784 5.08611451455965e-5 -5.33451634604883e-5 -4.5931308259622016e-5 -8.187799495355417e-5 -0.00010577696185502264 -1.36801313696368e-5 9.239411200686436e-5 4.878623484690523e-5 -7.521867474717351e-5 -2.372272639187789e-5 1.2753712771501384e-5 -0.00010129880639435121 -0.00012213514083706927 5.36130214546403e-5 -7.053678909089166e-7 5.0524723055406015e-5 -9.047599406623597e-5 -3.65797564067347e-5 0.00019653036769303175 -4.6495797600230365e-6 7.898204102238079e-5 5.4832250034075475e-5 9.152269966724131e-5 0.0002628497027122477 6.541701613588336e-6 -7.943869017426175e-7 -0.0002959131375159029 -2.0435607079152336e-6; -0.00010841332321136045 -3.9703712424606256e-5 -0.0001932483987518264 0.0001265662599719431 4.551926260617006e-5 -6.663149313383544e-5 8.802952881821625e-5 2.9608349471592735e-5 5.887965246372217e-5 -2.773686672001443e-5 3.5720522858108995e-6 -2.5988085569480977e-6 0.00022417228549172363 -0.00011335000952088083 0.00012366280363791787 -0.00012176560037617407 0.00016032824580476858 0.00010239579798805697 -0.0001067865791598951 -0.00021904708180657423 0.00010404860451969489 1.5584354080848394e-5 3.284574861324562e-5 -7.331712320294928e-5 9.639472885532404e-6 -8.244048283516027e-5 4.5807201352792225e-5 -4.756358746520072e-5 0.00010880852871493616 -0.0002107640734509269 2.60527472376209e-5 4.1854406411649454e-5; -1.4025104311962009e-5 1.5178371293793285e-5 0.00014560917655055436 1.2379298576184963e-5 4.102482373875672e-5 -2.7775756527055998e-5 -7.292285706332518e-5 5.149445380832391e-5 6.933082361522355e-5 2.0217998810286883e-6 6.842966716087569e-5 4.078301092543004e-5 -2.6424049990721167e-6 -2.6954091728633258e-5 3.169722797631697e-5 -3.699763080637491e-5 -1.5326340209661805e-5 -0.00021201534516128307 5.232533178807365e-5 0.00010518653901110812 2.791760992133926e-5 0.0001874154029139635 -9.375692140726902e-5 -1.3830491545171628e-5 -0.00017523837711612734 0.00014372818143622084 -7.149055570314312e-5 -4.0802767463694965e-5 -0.0001761477408506589 -0.00013428930221541375 5.672067593716191e-5 0.00015795199463193715; 5.634983603725145e-5 3.817681494750925e-5 3.045533909407988e-6 -5.133079326130777e-5 0.00016148336721579935 9.421200224663506e-5 -0.00013991056044120932 3.686945996944484e-5 9.942594619698081e-5 -6.075836068135762e-5 8.938408422745805e-5 0.00017542945710940545 0.00017171141366473746 0.00010989348079077378 -7.278439674119129e-6 4.503383747418406e-5 -8.59539432474571e-5 -1.6325318987365914e-5 -2.587856946596099e-6 1.3056590383930425e-5 -0.00015113314298447345 2.313790532410647e-5 5.64114852261255e-5 0.00018646385428494302 -2.0951658419862265e-5 -0.00011576060210592331 -3.6658799266454474e-5 7.078264747746157e-5 0.000350773021588099 4.495643583708433e-5 5.8147212208671565e-5 0.00014549542533699413; 1.36444873539994e-5 -2.8242617644756583e-5 8.479211601370149e-5 -0.00018651475920635968 7.555870752256674e-5 -7.059380231952509e-5 -0.0001403552255389858 -1.4369311883668477e-5 -5.8200216243880026e-5 0.00010130600048865601 -3.408417114698392e-5 -0.00010765288106925325 1.7572885099763894e-5 0.00015524875698316604 -0.00014815934491638658 -5.6588780807253056e-5 6.598380923675826e-5 0.00011115929874063897 3.626105672154677e-5 0.00012832858692559784 -0.00017676934157792967 -0.00013505032484248573 1.6748020698977152e-5 -6.74695061199893e-5 -0.0002883239308168389 -1.243294218439373e-5 9.003626974005442e-5 0.00010259874898179879 -0.00013190794061232738 -2.0618301731921795e-5 -2.8497017864730743e-5 -0.0001739661915955749], bias = [-3.1782316635731647e-9; -2.3926425218753917e-10; -6.349049350850525e-10; 5.4754575187597586e-11; 6.911214483236729e-10; -2.306003574685603e-9; -1.0972439832357306e-9; -4.450616914467885e-10; -2.2074461848142584e-9; -2.6715824738587848e-9; -4.669257839968026e-10; 2.0326828030083838e-10; 8.22965998978505e-10; -3.2542299250720646e-9; 3.8483654599730724e-9; 3.39356389017873e-10; -1.6608890071641562e-9; -1.184462206420971e-9; 2.4921600331027786e-9; -1.6726513030298377e-9; 1.7543753490174183e-9; -8.889938427804876e-10; -2.9402728491245674e-9; 2.5205008027970533e-9; 1.1541601458057496e-9; -7.303907586560552e-10; -3.778091811316876e-9; -6.107351682328665e-10; -2.74191487791267e-10; 3.990209981857559e-10; 5.5660586803634615e-9; -3.574768235994595e-9;;]), layer_4 = (weight = [-0.0006973010416167494 -0.0007154593013470952 -0.0008339462007034754 -0.0007890426734508419 -0.0007086592433319327 -0.0007110449951551801 -0.0006753444505976855 -0.0005586563183490761 -0.000864559330322939 -0.0006379681172723835 -0.0006941969950730902 -0.0006969699909775389 -0.0007576110932788714 -0.0005531736043933535 -0.0006375145307853702 -0.0005562734438622512 -0.0008695147542379866 -0.0006295645823025753 -0.0006462773520940191 -0.000880170247474688 -0.0006102530874270613 -0.0006218979618523946 -0.0007877002045428532 -0.0008222946270470636 -0.0007567901587056438 -0.0007205118527382253 -0.0005602637915904502 -0.0007087600584889926 -0.0006133889043416855 -0.0005355985766826453 -0.0005754944067910609 -0.0007676986214531152; 0.00035138893046644527 0.00010056974988758019 0.00019490232667322222 0.00030515519923718116 0.00029158570937742027 0.00034829260221823344 0.0003884192265170892 0.000265639070063974 0.00011683034304615483 0.00031005268166993497 0.00024295336547565084 0.0002582311640502737 0.00021139410480853924 0.00019217112694819055 0.0001132591042279884 0.0004121479514242483 0.00020861881260212216 0.00022228594823804434 0.0003383613728389406 0.0002166411630049519 0.00019955659969983245 0.00031845479276265427 0.00015138383822116427 0.00028660355366008595 0.00013087777824005823 0.0001458238016816683 0.00017140891972468807 0.000300335722210463 0.00013545963272749344 0.0001682773442113245 0.0002683464810622107 8.487016181707111e-5], bias = [-0.0006973306902572098; 0.0002450461996548737;;]))
```


<a id='Visualizing-the-Results'></a>

## Visualizing the Results


Let us now plot the loss over time


```julia
fig = with_theme(theme_web()) do
    fig = Figure()
    ax = CairoMakie.Axis(fig[1, 1]; xlabel="Iteration", ylabel="Loss")

    lines!(ax, losses; linewidth=2, alpha=0.75)

    return fig
end
```


![](1_GravitationalWaveForm-48.png)


Finally let us visualize the results


```julia
prob_nn = ODEProblem(ODE_model, u0, tspan, res.u)
soln_nn = Array(solve(prob_nn, RK4(); u0, p=res.u, saveat=tsteps, dt, adaptive=false))
waveform_nn_trained = first(compute_waveform(dt_data, soln_nn, mass_ratio,
    ode_model_params))

fig = with_theme(theme_web()) do
    fig = Figure()
    ax = CairoMakie.Axis(fig[1, 1]; xlabel="Time", ylabel="Waveform")

    l1 = lines!(ax, tsteps, waveform; linewidth=2, alpha=0.75)
    s1 = scatter!(ax, tsteps, waveform; markershape=:circle, markeralpha=0.25, alpha=0.5)

    l2 = lines!(ax, tsteps, waveform_nn; linewidth=2, alpha=0.75)
    s2 = scatter!(ax, tsteps, waveform_nn; markershape=:circle, markeralpha=0.25, alpha=0.5)

    l3 = lines!(ax, tsteps, waveform_nn_trained; linewidth=2, alpha=0.75)
    s3 = scatter!(ax, tsteps, waveform_nn_trained; markershape=:circle, markeralpha=0.25,
        alpha=0.5)

    axislegend(ax, [[l1, s1], [l2, s2], [l3, s3]],
        ["Waveform Data", "Waveform Neural Net (Untrained)", "Waveform Neural Net"];
        position=:lb)

    return fig
end
```


![](1_GravitationalWaveForm-50.png)


---


*This page was generated using [Literate.jl](https://github.com/fredrikekre/Literate.jl).*

